<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gaby Doces V29 (Final)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { 50: '#fff1f2', 100: '#ffe4e6', 500: '#ec4899', 600: '#db2777', 900: '#881337' }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'slide-up': 'slideUp 0.4s ease-out'
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #fff1f2; }
        .hide { display: none !important; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #ec4899; border-radius: 10px; }
    </style>
</head>
<body class="text-slate-800 h-screen flex overflow-hidden">

    <aside class="w-64 bg-white border-r border-pink-100 hidden md:flex flex-col shadow-xl z-20">
        <div class="p-8">
            <h1 class="text-3xl font-bold text-brand-600 flex items-center gap-2">
                <i class="fa-solid fa-lollipop"></i> Gaby<span class="text-slate-700">Doces</span>
            </h1>
            <p class="text-xs text-slate-400 mt-1 font-semibold tracking-wider">SISTEMA V29</p>
        </div>
        <nav class="flex-1 px-4 space-y-3">
            <button onclick="mudarAba('clientes')" class="nav-btn w-full flex items-center gap-4 px-6 py-4 rounded-2xl text-slate-500 hover:bg-brand-50 hover:text-brand-600 transition-all group font-medium bg-brand-50 text-brand-600" id="btn-clientes">
                <i class="fa-solid fa-users"></i> Clientes
            </button>
            <button onclick="mudarAba('cobranca')" class="nav-btn w-full flex items-center gap-4 px-6 py-4 rounded-2xl text-slate-500 hover:bg-brand-50 hover:text-brand-600 transition-all group font-medium" id="btn-cobranca">
                <i class="fa-solid fa-hand-holding-dollar"></i> Cobran√ßa
            </button>
            <button onclick="mudarAba('novo')" class="nav-btn w-full flex items-center gap-4 px-6 py-4 rounded-2xl text-slate-500 hover:bg-brand-50 hover:text-brand-600 transition-all group font-medium" id="btn-novo">
                <i class="fa-solid fa-user-plus"></i> Novo
            </button>
            <button onclick="mudarAba('prod')" class="nav-btn w-full flex items-center gap-4 px-6 py-4 rounded-2xl text-slate-500 hover:bg-brand-50 hover:text-brand-600 transition-all group font-medium" id="btn-prod">
                <i class="fa-solid fa-box-open"></i> Estoque
            </button>
            <button onclick="mudarAba('config')" class="nav-btn w-full flex items-center gap-4 px-6 py-4 rounded-2xl text-slate-500 hover:bg-brand-50 hover:text-brand-600 transition-all group font-medium" id="btn-config">
                <i class="fa-solid fa-gear"></i> Config
            </button>
        </nav>
    </aside>

    <main class="flex-1 flex flex-col h-screen overflow-hidden relative bg-gradient-to-br from-brand-50 to-white">
        
        <header class="bg-white/90 backdrop-blur border-b border-pink-100 p-4 flex justify-between items-center md:hidden z-10 sticky top-0">
            <h1 class="font-bold text-brand-600 text-xl"><i class="fa-solid fa-lollipop"></i> GabyDoces</h1>
            <button onclick="document.querySelector('aside').classList.toggle('hidden'); document.querySelector('aside').classList.toggle('absolute'); document.querySelector('aside').classList.toggle('h-full');" class="text-slate-500 p-2 text-xl"><i class="fa-solid fa-bars"></i></button>
        </header>

        <div class="flex-1 overflow-y-auto p-4 md:p-8 relative scroll-smooth">
            
            <section id="tab-clientes" class="animate-fade-in space-y-6">
                <div class="flex flex-col md:flex-row gap-4 bg-white p-2 rounded-3xl shadow-sm border border-brand-100">
                    <div class="flex-1 relative">
                        <i class="fa-solid fa-magnifying-glass absolute left-5 top-4 text-slate-300"></i>
                        <input type="text" id="buscaNome" onkeyup="renderClientes()" placeholder="Quem voc√™ procura?" class="w-full pl-12 pr-4 py-3 bg-transparent focus:bg-brand-50 rounded-2xl outline-none transition-all placeholder-slate-400">
                    </div>
                    <select id="filtroSetor" onchange="renderClientes()" class="px-6 py-3 bg-slate-50 rounded-2xl outline-none border-l border-slate-100 text-slate-600 font-medium cursor-pointer hover:bg-slate-100 transition">
                        <option value="">Todos os Setores</option>
                        <option value="IGREJA">Igreja</option><option value="ROLETE">Rolete</option><option value="TABATA">Tabata</option>
                        <option value="ANDERSON">Anderson</option><option value="BIANCA">Bianca</option><option value="RUA">Rua</option>
                    </select>
                </div>

                <div id="gridClientes" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5 pb-10">
                    <div class="col-span-3 text-center text-slate-400 py-10">Carregando sistema...</div>
                </div>
            </section>

            <section id="tab-cobranca" class="hide animate-fade-in space-y-8">
                <h2 class="text-3xl font-bold text-slate-800 tracking-tight">Painel Financeiro</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
                    <div onclick="renderCobranca('hoje')" class="cursor-pointer bg-white p-6 rounded-3xl shadow-sm border-b-4 border-blue-400 hover:-translate-y-1 transition-all">
                        <div class="text-blue-500 font-bold uppercase text-xs tracking-wider mb-2">Vence Hoje</div>
                        <div class="text-3xl font-black text-slate-800" id="total-hoje">R$ 0,00</div>
                    </div>
                    <div onclick="renderCobranca('avencer')" class="cursor-pointer bg-white p-6 rounded-3xl shadow-sm border-b-4 border-green-400 hover:-translate-y-1 transition-all">
                        <div class="text-green-500 font-bold uppercase text-xs tracking-wider mb-2">A Vencer</div>
                        <div class="text-3xl font-black text-slate-800" id="total-avencer">R$ 0,00</div>
                    </div>
                    <div onclick="renderCobranca('atrasados')" class="cursor-pointer bg-white p-6 rounded-3xl shadow-sm border-b-4 border-red-400 hover:-translate-y-1 transition-all">
                        <div class="text-red-500 font-bold uppercase text-xs tracking-wider mb-2">Em Atraso</div>
                        <div class="text-3xl font-black text-slate-800" id="total-atrasados">R$ 0,00</div>
                    </div>
                </div>
                <div id="listaCobranca" class="bg-white rounded-3xl shadow-lg border border-slate-100 overflow-hidden"></div>
            </section>

            <section id="tab-novo" class="hide animate-slide-up">
                <div class="max-w-lg mx-auto bg-white p-10 rounded-3xl shadow-xl border border-brand-100">
                    <h2 class="text-2xl font-bold mb-8 text-slate-800 text-center">Cadastrar Cliente</h2>
                    <div class="space-y-5">
                        <input type="text" id="novoNome" class="w-full p-4 bg-slate-50 border border-transparent focus:border-brand-300 rounded-xl outline-none transition-all" placeholder="Nome Completo">
                        <div class="grid grid-cols-2 gap-4">
                            <select id="novoSetor" class="w-full p-4 bg-slate-50 border border-transparent focus:border-brand-300 rounded-xl outline-none">
                                <option value="IGREJA">Igreja</option><option value="ROLETE">Rolete</option>
                                <option value="TABATA">Tabata</option><option value="RUA">Rua/Outros</option>
                            </select>
                            <input type="text" id="novoTel" class="w-full p-4 bg-slate-50 border border-transparent focus:border-brand-300 rounded-xl outline-none" placeholder="Telefone">
                        </div>
                        <select id="novoDia" class="w-full p-4 bg-slate-50 border border-transparent focus:border-brand-300 rounded-xl outline-none text-slate-600">
                            <option value="">Dia de Vencimento Fixo...</option>
                        </select>
                        <button onclick="salvarNovoCliente()" class="w-full bg-brand-600 hover:bg-brand-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-brand-200 transition-transform transform active:scale-95 mt-4">
                            SALVAR CLIENTE
                        </button>
                    </div>
                </div>
            </section>

            <section id="tab-prod" class="hide animate-fade-in">
                <div class="max-w-3xl mx-auto space-y-6">
                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-brand-100 flex gap-4 items-center">
                        <input type="text" id="prodNome" class="flex-1 p-3 bg-slate-50 rounded-xl outline-none" placeholder="Nome do Produto">
                        <input type="number" id="prodPreco" class="w-28 p-3 bg-slate-50 rounded-xl outline-none" placeholder="Pre√ßo">
                        <button onclick="addProduto()" class="bg-brand-500 text-white h-12 w-12 rounded-xl hover:bg-brand-600 transition shadow-lg flex items-center justify-center"><i class="fa-solid fa-plus"></i></button>
                    </div>
                    <ul id="listaProdutos" class="grid grid-cols-1 md:grid-cols-2 gap-3"></ul>
                </div>
            </section>

             <section id="tab-config" class="hide animate-fade-in">
                <div class="max-w-2xl mx-auto space-y-8">
                    <div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-100 text-center relative overflow-hidden group">
                        <div class="absolute top-0 left-0 w-2 h-full bg-green-500"></div>
                        <i class="fa-solid fa-file-excel text-5xl text-green-500 mb-4 group-hover:scale-110 transition-transform"></i>
                        <h3 class="text-xl font-bold text-slate-700">Importar Planilha</h3>
                        <p class="text-sm text-slate-400 mb-6">Suporta layout com colunas duplas de produtos</p>
                        <label class="inline-block px-8 py-3 bg-green-50 text-green-700 font-bold rounded-xl cursor-pointer hover:bg-green-100 transition">
                            Escolher Arquivo
                            <input type="file" id="arquivoExcel" class="hidden" accept=".xlsx, .xls" onchange="importarExcel()">
                        </label>
                    </div>
                    
                    <div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-100">
                        <h3 class="font-bold text-slate-700 mb-6 flex items-center gap-2"><i class="fa-brands fa-whatsapp text-green-500"></i> Mensagens Autom√°ticas</h3>
                        <div class="space-y-4">
                            <input id="cfgPix" class="w-full p-3 border rounded-xl text-sm" placeholder="Sua Chave PIX">
                            <textarea id="msgHoje" class="w-full p-3 border rounded-xl text-sm" rows="2" placeholder="Modelo Vence Hoje"></textarea>
                            <textarea id="msgAtrasado" class="w-full p-3 border rounded-xl text-sm" rows="2" placeholder="Modelo Atrasado"></textarea>
                            <button onclick="salvarConfig()" class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold hover:bg-slate-900">Salvar Configura√ß√µes</button>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <div id="modalVenda" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4 transition-opacity">
        <div class="bg-white w-full max-w-md rounded-3xl shadow-2xl overflow-hidden animate-slide-up">
            <div class="bg-brand-500 p-6 flex justify-between items-center text-white">
                <div>
                    <h3 class="font-bold text-lg">Nova Venda</h3>
                    <p class="text-xs opacity-90" id="mv-nome">Cliente</p>
                </div>
                <button onclick="fecharModal('modalVenda')" class="bg-white/20 hover:bg-white/30 w-8 h-8 rounded-full">‚úï</button>
            </div>
            <div class="p-6 space-y-4">
                <div class="flex gap-2 items-center bg-slate-50 p-2 rounded-xl border border-slate-200">
                    <input type="date" id="mv-data" class="bg-transparent text-slate-600 text-sm outline-none font-bold">
                    <span class="text-xs text-slate-400">Data da Venda</span>
                </div>

                <div class="flex gap-2">
                    <select id="mv-prod" class="flex-1 border-slate-200 border bg-white p-3 rounded-xl outline-none text-slate-700 font-medium"></select>
                    <input id="mv-qtd" type="number" value="1" class="w-16 border-slate-200 border p-3 rounded-xl text-center outline-none">
                    <button onclick="addCarrinho()" class="bg-brand-500 text-white w-12 rounded-xl hover:bg-brand-600 text-xl font-bold">+</button>
                </div>

                <div id="mv-lista" class="bg-slate-50 p-3 rounded-xl h-32 overflow-y-auto space-y-2 border border-slate-100">
                    <div class="text-center text-xs text-slate-400 mt-10">Carrinho vazio</div>
                </div>

                <div class="flex justify-between font-bold text-xl text-slate-800 pt-2 border-t border-slate-100">
                    <span>Total</span> <span id="mv-total">R$ 0,00</span>
                </div>

                <button onclick="finalizarVenda()" class="w-full bg-brand-600 hover:bg-brand-700 text-white py-4 rounded-xl font-bold shadow-lg shadow-brand-200 transition">
                    LAN√áAR NA CONTA
                </button>
            </div>
        </div>
    </div>

    <div id="modalPgto" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-3xl shadow-2xl p-6 text-center animate-slide-up relative">
            <button onclick="fecharModal('modalPgto')" class="absolute top-4 right-4 text-slate-300 hover:text-slate-500">‚úï</button>
            <div class="w-16 h-16 bg-green-100 text-green-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">
                <i class="fa-solid fa-hand-holding-dollar"></i>
            </div>
            <h3 class="font-bold text-lg text-slate-800">Receber Pagamento</h3>
            <p class="text-sm text-slate-400 mb-6">Cliente: <span id="mp-nome" class="font-bold text-slate-600">...</span></p>
            
            <input type="date" id="mp-data" class="w-full mb-4 p-2 bg-slate-50 border border-slate-200 rounded-lg text-center text-slate-500 font-bold">
            
            <div class="relative mb-6">
                <span class="absolute left-4 top-3 text-slate-400 font-bold text-xl">R$</span>
                <input type="number" id="mp-valor" class="w-full pl-12 pr-4 py-3 bg-slate-50 rounded-2xl text-3xl font-bold text-slate-800 outline-none focus:ring-2 focus:ring-green-400 transition" placeholder="0,00">
            </div>

            <button onclick="confirmarPgto()" class="w-full bg-green-500 hover:bg-green-600 py-4 rounded-xl font-bold text-white shadow-lg shadow-green-200 transition">CONFIRMAR RECEBIMENTO</button>
        </div>
    </div>

    <div id="modalEditar" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-3xl shadow-2xl p-8 animate-slide-up relative">
            <h3 class="font-bold text-xl mb-6 text-slate-800"><i class="fa-solid fa-pen-to-square text-orange-400"></i> Editar Dados</h3>
            
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase">Nome</label>
                    <input id="ed-nome" class="w-full p-3 border rounded-xl font-bold text-slate-700">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase">Setor</label>
                        <select id="ed-setor" class="w-full p-3 border rounded-xl bg-white"></select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase">Vencimento</label>
                        <select id="ed-dia" class="w-full p-3 border rounded-xl bg-white"></select>
                    </div>
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase">Telefone</label>
                    <input id="ed-tel" class="w-full p-3 border rounded-xl text-slate-700">
                </div>
            </div>

            <div class="flex gap-3 mt-8">
                <button onclick="fecharModal('modalEditar')" class="flex-1 bg-slate-100 text-slate-500 font-bold py-3 rounded-xl">Cancelar</button>
                <button onclick="salvarEdicao()" class="flex-1 bg-slate-800 text-white font-bold py-3 rounded-xl hover:bg-black">Salvar Altera√ß√µes</button>
            </div>
        </div>
    </div>

    <div id="modalExtrato" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-2xl rounded-3xl shadow-2xl overflow-hidden animate-slide-up flex flex-col max-h-[90vh]">
            <div class="bg-slate-50 p-6 border-b border-slate-100 flex justify-between items-center">
                <div>
                    <h3 class="font-bold text-xl text-slate-800">Extrato Detalhado</h3>
                    <p class="text-sm text-slate-400" id="ex-nome">Hist√≥rico</p>
                </div>
                <button onclick="fecharModal('modalExtrato')" class="bg-white border border-slate-200 w-8 h-8 rounded-full text-slate-400">‚úï</button>
            </div>
            
            <div class="p-0 overflow-y-auto flex-1 bg-slate-50/50">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-slate-100 text-slate-500 text-xs uppercase sticky top-0">
                        <tr>
                            <th class="p-4">Data</th>
                            <th class="p-4">Descri√ß√£o</th>
                            <th class="p-4 text-right">Valor</th>
                        </tr>
                    </thead>
                    <tbody id="ex-lista" class="text-sm divide-y divide-slate-100 bg-white">
                        </tbody>
                </table>
            </div>
            
            <div class="p-4 bg-white border-t border-slate-100 flex justify-between items-center">
                <span class="text-slate-400 text-xs">Saldo Atual do Cliente:</span>
                <span id="ex-saldo-final" class="font-bold text-xl">R$ 0,00</span>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-5 right-5 bg-slate-800 text-white px-6 py-4 rounded-xl shadow-2xl transform translate-y-20 opacity-0 transition-all z-[60] font-bold flex items-center gap-3">
        <i class="fa-solid fa-check-circle text-green-400"></i> <span id="toast-msg">Sucesso!</span>
    </div>

    <script>
        // CONFIG DO FIREBASE (Sua Chave)
        const firebaseConfig = {
            apiKey: "AIzaSyBUFv4jrng5g-0eUT9zjDukZGA46eVH7g0",
            authDomain: "gabydoces-d0cd1.firebaseapp.com",
            projectId: "gabydoces-d0cd1",
            storageBucket: "gabydoces-d0cd1.firebasestorage.app",
            messagingSenderId: "702910388683",
            appId: "1:702910388683:web:28facd97365fb586373e4e"
        };

        // INICIALIZAR FIREBASE (Modo Compat)
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // ESTADOS GLOBAIS
        let CLIENTES = [];
        let PRODUTOS = [];
        let CARRINHO = [];
        let CLIENTE_ATUAL = null;
        let CONFIG = { pix: "", hoje: "", atrasado: "" };

        // --- INICIALIZA√á√ÉO ---
        window.onload = async () => {
            // Selects Dias
            const diasHtml = '<option value="">Sem dia fixo</option>' + [...Array(31)].map((_, i) => `<option value="${i+1}">Dia ${i+1}</option>`).join('');
            document.getElementById('novoDia').innerHTML = diasHtml;
            document.getElementById('ed-dia').innerHTML = diasHtml;

            // Selects Setores
            const setoresHtml = document.getElementById('novoSetor').innerHTML;
            document.getElementById('ed-setor').innerHTML = setoresHtml;

            await carregarDados();
        };

        async function carregarDados() {
            // Clientes
            const snapC = await db.collection("clientes").get();
            CLIENTES = [];
            snapC.forEach(d => CLIENTES.push({id: d.id, ...d.data()}));
            CLIENTES.sort((a,b) => a.nome.localeCompare(b.nome));

            // Produtos
            const snapP = await db.collection("produtos").get();
            PRODUTOS = [];
            snapP.forEach(d => PRODUTOS.push({id: d.id, ...d.data()}));

            // Config
            try {
                const snapCfg = await db.collection("config").doc("templates").get();
                if(snapCfg.exists) CONFIG = snapCfg.data();
                document.getElementById('cfgPix').value = CONFIG.pix || "";
                document.getElementById('msgHoje').value = CONFIG.hoje || "";
                document.getElementById('msgAtrasado').value = CONFIG.atrasado || "";
            } catch(e){}

            renderClientes();
            renderProdutos();
        }

        // --- RENDERIZADORES ---
        window.renderClientes = () => {
            const grid = document.getElementById('gridClientes');
            const busca = document.getElementById('buscaNome').value.toUpperCase();
            const setor = document.getElementById('filtroSetor').value;
            grid.innerHTML = '';

            const filtrados = CLIENTES.filter(c => {
                if(busca && !c.nome.includes(busca)) return false;
                if(setor && c.setor !== setor) return false;
                return true;
            });

            if(filtrados.length === 0) {
                grid.innerHTML = `<div class="col-span-3 text-center py-10 opacity-50"><i class="fa-solid fa-ghost text-4xl mb-2"></i><p>Ningu√©m encontrado</p></div>`;
                return;
            }

            filtrados.forEach(c => {
                const saldo = c.saldo || 0;
                const devendo = saldo < -0.05;
                const venc = calcularVencimento(c.dia_pagamento, c.ultima_venda);
                const dataVenc = venc ? venc.toLocaleDateString('pt-BR') : '---';
                
                grid.innerHTML += `
                <div class="bg-white rounded-3xl p-5 shadow-sm border border-slate-100 hover:shadow-md transition-all relative group">
                    <button onclick="abrirEditar('${c.id}')" class="absolute top-4 right-4 text-slate-300 hover:text-orange-400 transition-colors p-2"><i class="fa-solid fa-pen"></i></button>
                    
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-12 h-12 rounded-2xl ${devendo ? 'bg-red-50 text-red-500' : 'bg-green-50 text-green-500'} flex items-center justify-center font-bold text-xl">
                            ${c.nome.charAt(0)}
                        </div>
                        <div class="overflow-hidden">
                            <h3 class="font-bold text-slate-800 truncate">${c.nome}</h3>
                            <span class="text-[10px] bg-slate-100 text-slate-500 px-2 py-0.5 rounded-md font-bold uppercase tracking-wide">${c.setor}</span>
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-end bg-slate-50 p-3 rounded-2xl mb-3">
                        <div>
                            <p class="text-xs text-slate-400 font-bold uppercase">Saldo Atual</p>
                            <p class="text-xl font-black ${devendo ? 'text-red-500' : 'text-green-500'}">R$ ${Math.abs(saldo).toFixed(2)}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-xs text-slate-400 font-bold uppercase">Vence</p>
                            <p class="text-sm font-bold text-slate-600">${dataVenc}</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="abrirVenda('${c.id}')" class="bg-red-500 hover:bg-red-600 text-white py-2 rounded-xl text-sm font-bold transition">Vender</button>
                        <button onclick="abrirPagamento('${c.id}')" class="bg-green-500 hover:bg-green-600 text-white py-2 rounded-xl text-sm font-bold transition">Receber</button>
                        <button onclick="verExtrato('${c.id}')" class="bg-slate-200 hover:bg-slate-300 text-slate-600 py-2 rounded-xl text-sm font-bold transition">Extrato</button>
                    </div>
                </div>`;
            });
        };

        window.renderCobranca = (tipo) => {
            const lista = document.getElementById('listaCobranca');
            lista.innerHTML = '';
            let total = 0;

            const filtrados = CLIENTES.filter(c => {
                if(c.saldo >= -0.01 || !c.dia_pagamento) return false;
                const status = obterStatusVenc(c.dia_pagamento, c.ultima_venda);
                return status === tipo;
            });

            if(filtrados.length === 0) lista.innerHTML = `<div class="p-8 text-center text-slate-400">Ningu√©m nesta lista! üéâ</div>`;

            filtrados.forEach(c => {
                total += Math.abs(c.saldo);
                const venc = calcularVencimento(c.dia_pagamento, c.ultima_venda).toLocaleDateString('pt-BR');
                const zapLink = gerarLinkZap(c, tipo, venc);

                lista.innerHTML += `
                <div class="p-4 flex justify-between items-center hover:bg-slate-50 border-b border-slate-100 last:border-0">
                    <div>
                        <div class="font-bold text-slate-700">${c.nome}</div>
                        <div class="text-xs text-slate-400">Venc: ${venc}</div>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="font-bold text-red-600">R$ ${Math.abs(c.saldo).toFixed(2)}</div>
                        <a href="${zapLink}" target="_blank" class="w-10 h-10 rounded-full bg-green-500 text-white flex items-center justify-center hover:bg-green-600 shadow-md shadow-green-200"><i class="fa-brands fa-whatsapp"></i></a>
                    </div>
                </div>`;
            });

            document.getElementById(`total-${tipo}`).innerText = `R$ ${total.toFixed(2)}`;
        };

        window.renderProdutos = () => {
            const lista = document.getElementById('listaProdutos');
            const select = document.getElementById('mv-prod');
            lista.innerHTML = ''; select.innerHTML = '<option value="">Selecione...</option>';

            PRODUTOS.forEach(p => {
                lista.innerHTML += `
                <div class="flex justify-between items-center p-4 bg-white border border-slate-100 rounded-2xl">
                    <span class="font-medium text-slate-700">${p.nome}</span>
                    <span class="font-bold text-brand-600 bg-brand-50 px-3 py-1 rounded-lg">R$ ${p.preco.toFixed(2)}</span>
                </div>`;
                select.innerHTML += `<option value="${p.preco}" data-nome="${p.nome}">${p.nome}</option>`;
            });
        };

        // --- L√ìGICA DE NEG√ìCIO ---
        function calcularVencimento(diaPag, ultimaVenda) {
            if(!diaPag) return null;
            let d = ultimaVenda ? new Date(ultimaVenda + 'T12:00:00') : new Date();
            let dia = parseInt(diaPag);
            let ano = d.getFullYear(), mes = d.getMonth();
            if(d.getDate() > dia) mes++;
            if(mes > 11) { mes = 0; ano++; }
            const ultimo = new Date(ano, mes + 1, 0).getDate();
            return new Date(ano, mes, Math.min(dia, ultimo));
        }

        function obterStatusVenc(dia, ultVenda) {
            const v = calcularVencimento(dia, ultVenda); if(!v) return 'nada';
            v.setHours(0,0,0,0);
            const hoje = new Date(); hoje.setHours(0,0,0,0);
            if(v.getTime() === hoje.getTime()) return 'hoje';
            if(v.getTime() < hoje.getTime()) return 'atrasados';
            return 'avencer';
        }

        function gerarLinkZap(c, tipo, dataVenc) {
            let msg = CONFIG[tipo] || "";
            msg = msg.replace(/{nome}/g, c.nome)
                     .replace(/{valor}/g, Math.abs(c.saldo).toFixed(2))
                     .replace(/{vencimento}/g, dataVenc)
                     .replace(/{pix}/g, CONFIG.pix);
            return `https://wa.me/55${c.telefone.replace(/\D/g,'')}?text=${encodeURIComponent(msg)}`;
        }

        // --- A√á√ïES ---
        window.mudarAba = (aba) => {
            document.querySelectorAll('section').forEach(s => s.classList.add('hide'));
            document.getElementById(`tab-${aba}`).classList.remove('hide');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('bg-brand-50', 'text-brand-600'));
            document.getElementById(`btn-${aba}`).classList.add('bg-brand-50', 'text-brand-600');
            if(aba === 'cobranca') { renderCobranca('hoje'); renderCobranca('avencer'); renderCobranca('atrasados'); }
        };

        // EDITAR
        window.abrirEditar = (id) => {
            const c = CLIENTES.find(x => x.id === id);
            CLIENTE_ATUAL = c;
            document.getElementById('ed-nome').value = c.nome;
            document.getElementById('ed-tel').value = c.telefone;
            document.getElementById('ed-setor').value = c.setor;
            document.getElementById('ed-dia').value = c.dia_pagamento;
            document.getElementById('modalEditar').classList.remove('hidden');
        };

        window.salvarEdicao = async () => {
            await db.collection("clientes").doc(CLIENTE_ATUAL.id).update({
                nome: document.getElementById('ed-nome').value.toUpperCase(),
                setor: document.getElementById('ed-setor').value,
                telefone: document.getElementById('ed-tel').value,
                dia_pagamento: document.getElementById('ed-dia').value
            });
            fecharModal('modalEditar'); carregarDados(); mostrarToast("Atualizado!");
        };

        // VENDA
        window.abrirVenda = (id) => {
            CLIENTE_ATUAL = CLIENTES.find(c => c.id === id);
            document.getElementById('mv-nome').innerText = CLIENTE_ATUAL.nome;
            document.getElementById('mv-data').valueAsDate = new Date();
            CARRINHO = []; atualizarCarrinho();
            document.getElementById('modalVenda').classList.remove('hidden');
        };

        window.addCarrinho = () => {
            const sel = document.getElementById('mv-prod');
            const nome = sel.options[sel.selectedIndex]?.getAttribute('data-nome');
            const preco = parseFloat(sel.value);
            const qtd = parseFloat(document.getElementById('mv-qtd').value);
            if(nome) { CARRINHO.push({nome, qtd, total: preco*qtd}); atualizarCarrinho(); }
        };

        window.rmItem = (idx) => { CARRINHO.splice(idx,1); atualizarCarrinho(); };

        function atualizarCarrinho() {
            const div = document.getElementById('mv-lista');
            let total = 0; div.innerHTML = '';
            CARRINHO.forEach((i, idx) => {
                total += i.total;
                div.innerHTML += `<div class="flex justify-between items-center text-sm p-2 bg-white rounded-lg border border-slate-100 mb-1"><div><span class="font-bold">${i.qtd}x</span> ${i.nome}</div><div class="font-bold text-slate-600">R$ ${i.total.toFixed(2)} <button onclick="rmItem(${idx})" class="ml-2 text-red-400">x</button></div></div>`;
            });
            if(CARRINHO.length===0) div.innerHTML = '<div class="text-center text-xs text-slate-400 mt-10">Vazio</div>';
            document.getElementById('mv-total').innerText = `R$ ${total.toFixed(2)}`;
        }

        window.finalizarVenda = async () => {
            if(CARRINHO.length === 0) return;
            const dataVenda = document.getElementById('mv-data').value;
            const total = CARRINHO.reduce((acc, i) => acc + i.total, 0);
            
            await db.collection("clientes").doc(CLIENTE_ATUAL.id).update({
                saldo: (CLIENTE_ATUAL.saldo || 0) - total,
                ultima_venda: dataVenda
            });

            await db.collection("transacoes").add({
                cliente_id: CLIENTE_ATUAL.id,
                tipo: 'VENDA',
                valor: total,
                descricao: CARRINHO.map(i => `${i.qtd}x ${i.nome}`).join(', '),
                data: dataVenda,
                timestamp: new Date()
            });

            fecharModal('modalVenda'); carregarDados(); mostrarToast("Venda OK!");
        };

        // PAGAMENTO
        window.abrirPagamento = (id) => {
            CLIENTE_ATUAL = CLIENTES.find(c => c.id === id);
            document.getElementById('mp-nome').innerText = CLIENTE_ATUAL.nome;
            document.getElementById('mp-data').valueAsDate = new Date();
            document.getElementById('mp-valor').value = '';
            document.getElementById('modalPgto').classList.remove('hidden');
        };

        window.confirmarPgto = async () => {
            const valor = parseFloat(document.getElementById('mp-valor').value);
            if(!valor) return;
            const dataPgto = document.getElementById('mp-data').value;

            await db.collection("clientes").doc(CLIENTE_ATUAL.id).update({
                saldo: (CLIENTE_ATUAL.saldo || 0) + valor
            });

            await db.collection("transacoes").add({
                cliente_id: CLIENTE_ATUAL.id,
                tipo: 'PAGAMENTO',
                valor: valor,
                data: dataPgto,
                timestamp: new Date()
            });

            fecharModal('modalPgto'); carregarDados(); mostrarToast("Recebido!");
        };

        // EXTRATO
        window.verExtrato = async (id) => {
            const cli = CLIENTES.find(c => c.id === id);
            document.getElementById('ex-nome').innerText = cli.nome;
            document.getElementById('ex-saldo-final').innerText = `R$ ${Math.abs(cli.saldo).toFixed(2)}`;
            const tbody = document.getElementById('ex-lista');
            tbody.innerHTML = '<tr><td colspan="3" class="p-4 text-center">Carregando...</td></tr>';
            document.getElementById('modalExtrato').classList.remove('hidden');

            const snap = await db.collection("transacoes").where("cliente_id", "==", id).orderBy("data", "desc").get();
            tbody.innerHTML = '';
            if(snap.empty) { tbody.innerHTML = '<tr><td colspan="3" class="p-4 text-center">Nada encontrado.</td></tr>'; return; }

            snap.forEach(doc => {
                const t = doc.data();
                const isVenda = t.tipo === 'VENDA';
                const dataFmt = t.data.split('-').reverse().slice(0,2).join('/');
                tbody.innerHTML += `
                <tr class="hover:bg-slate-50 transition">
                    <td class="p-4 text-slate-500 font-medium">${dataFmt}</td>
                    <td class="p-4"><span class="block font-bold text-slate-700">${isVenda?'Compra':'Pagamento'}</span><span class="text-xs text-slate-400">${t.descricao||'Pagamento'}</span></td>
                    <td class="p-4 text-right font-bold ${isVenda?'text-red-500':'text-green-500'}">${isVenda?'-':'+'} R$ ${t.valor.toFixed(2)}</td>
                </tr>`;
            });
        };

        // GERAIS
        window.fecharModal = (id) => document.getElementById(id).classList.add('hidden');
        window.mostrarToast = (msg) => {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            t.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => t.classList.add('translate-y-20', 'opacity-0'), 3000);
        };
        
        window.salvarNovoCliente = async () => {
            const nome = document.getElementById('novoNome').value.toUpperCase();
            if(nome) {
                await db.collection("clientes").add({
                    nome, setor: document.getElementById('novoSetor').value,
                    telefone: document.getElementById('novoTel').value,
                    dia_pagamento: document.getElementById('novoDia').value,
                    saldo: 0
                });
                document.getElementById('novoNome').value = '';
                carregarDados(); mudarAba('clientes'); mostrarToast("Cadastrado!");
            }
        };

        window.addProduto = async () => {
            const nome = document.getElementById('prodNome').value.toUpperCase();
            const preco = parseFloat(document.getElementById('prodPreco').value);
            if(nome && preco) {
                await db.collection("produtos").add({nome, preco});
                document.getElementById('prodNome').value = '';
                carregarDados(); mostrarToast("Produto Add!");
            }
        };

        window.salvarConfig = async () => {
            await db.collection("config").doc("templates").set({
                pix: document.getElementById('cfgPix').value,
                hoje: document.getElementById('msgHoje').value,
                atrasado: document.getElementById('msgAtrasado').value
            });
            mostrarToast("Config Salva!");
        };
        
        // Importar Excel (Mantido l√≥gica)
        window.importarExcel = async () => {
            const file = document.getElementById('arquivoExcel').files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const wb = XLSX.read(e.target.result, {type: 'array'});
                const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header: 1});
                
                // Mapeamento
                const mapCli = {}; CLIENTES.forEach(c => mapCli[c.nome] = c);
                const mapProd = {}; PRODUTOS.forEach(p => mapProd[p.nome] = p.preco);
                let count = 0;

                for(let i=1; i<json.length; i++) {
                    const row = json[i];
                    if(!row || !row[1]) continue;
                    const nome = row[1].toString().toUpperCase().trim();
                    const setor = (row[0]||"RUA").toString().toUpperCase();
                    const tel = (row[14]||"").toString().replace(/\D/g, "");
                    
                    let itens = [], totalLinha = 0;
                    for(let k=2; k<=12; k+=2) {
                        const prod = (row[k]||"").toString().toUpperCase().trim();
                        const qtd = parseFloat(row[k+1]);
                        if(prod && qtd > 0) {
                            const preco = mapProd[prod] || 0;
                            totalLinha += preco * qtd;
                            itens.push(`${qtd}x ${prod}`);
                        }
                    }

                    if(itens.length > 0) {
                        let id = null, saldo = 0;
                        if(mapCli[nome]) { id = mapCli[nome].id; saldo = mapCli[nome].saldo; }
                        else {
                            const ref = await db.collection("clientes").add({nome, setor, telefone: tel, dia_pagamento: "", saldo: 0});
                            id = ref.id;
                        }
                        await db.collection("clientes").doc(id).update({ saldo: saldo - totalLinha, ultima_venda: new Date().toISOString().split('T')[0] });
                        await db.collection("transacoes").add({
                            cliente_id: id, tipo: 'VENDA', metodo: 'FIADO', valor: totalLinha, descricao: itens.join(', '), data: new Date().toISOString().split('T')[0], timestamp: new Date()
                        });
                        count++;
                    }
                }
                alert(`Importado! ${count} vendas.`); carregarDados();
            };
            reader.readAsArrayBuffer(file);
        };
    </script>
</body>
</html>
