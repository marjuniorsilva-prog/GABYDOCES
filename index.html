<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gaby Doces - Sistema V6.0</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <style>
        body { background-color: #f0f2f5; padding-bottom: 80px; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        
        /* Navega√ß√£o */
        .nav-pills .nav-link { background: white; color: #555; border: 1px solid #ddd; margin: 0 2px; font-size: 0.8rem; }
        .nav-pills .nav-link.active { background-color: #d63384; color: white; border-color: #d63384; font-weight: bold; box-shadow: 0 4px 6px rgba(214, 51, 132, 0.3); }
        
        /* Cards do Dashboard (Bot√µes) */
        .card-dash { cursor: pointer; transition: transform 0.2s; color: white; border: none; }
        .card-dash:active { transform: scale(0.95); }
        .bg-fiado { background: linear-gradient(135deg, #ff416c, #ff4b2b); }
        .bg-vista { background: linear-gradient(135deg, #11998e, #38ef7d); }
        .bg-atrasado { background: linear-gradient(135deg, #232526, #414345); }

        /* Status Cliente */
        .card-cliente { border-left: 5px solid #ccc; }
        .status-devendo { border-left-color: #dc3545; background-color: #fff5f5; }
        .status-ok { border-left-color: #198754; background-color: #fff; }
        .texto-devendo { color: #dc3545; font-weight: 800; }
        .texto-ok { color: #198754; font-weight: 800; }

        /* Bot√£o Flutuante Venda */
        .fab { position: fixed; bottom: 85px; right: 20px; width: 60px; height: 60px; border-radius: 30px; font-size: 24px; box-shadow: 0 4px 8px rgba(0,0,0,0.3); z-index: 1000; }
    </style>
</head>
<body>

<div class="container mt-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="fw-bold text-secondary m-0">üç¨ Gaby Doces <span class="badge bg-dark small">V6.0</span></h5>
        <button class="btn btn-sm btn-outline-secondary" onclick="location.reload()">üîÑ</button>
    </div>

    <ul class="nav nav-pills nav-fill mb-4" id="menuPrincipal" role="tablist">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-inicio">üè† In√≠cio</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-dash" onclick="carregarDashboard()">üìä Painel</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-novo">üë§ Novo</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-prod">üì¶ Prod</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-config">‚öôÔ∏è Excel</button></li>
    </ul>
</div>

<div class="tab-content container">

    <div class="tab-pane fade show active" id="tab-inicio">
        <div class="input-group mb-3">
            <input type="text" id="buscaNome" class="form-control" placeholder="üîç Buscar cliente..." onkeyup="carregarClientes()">
            <select id="filtroSetor" class="form-select" style="max-width: 120px;" onchange="carregarClientes()">
                <option value="">Setor</option>
                <option value="IGREJA">Igreja</option>
                <option value="ROLETE">Rolete</option>
                <option value="TABATA">Tabata</option>
                <option value="ANDERSON">Anderson</option>
                <option value="BIANCA">Bianca</option>
                <option value="RUA">Rua</option>
            </select>
        </div>
        <div id="listaClientes" class="row pb-5">
            <div class="text-center mt-5"><div class="spinner-border text-primary"></div></div>
        </div>
    </div>

    <div class="tab-pane fade" id="tab-dash">
        <div class="card mb-3 shadow-sm">
            <div class="card-body p-2 d-flex gap-2 align-items-center">
                <input type="date" id="dataDash1" class="form-control form-control-sm">
                <span class="small">at√©</span>
                <input type="date" id="dataDash2" class="form-control form-control-sm">
                <button class="btn btn-sm btn-dark" onclick="carregarDashboard()">Filtrar</button>
            </div>
        </div>

        <div class="row g-2">
            <div class="col-6">
                <div class="card card-dash bg-fiado p-3 shadow" onclick="verRelatorio('DEVEDORES')">
                    <small>A Receber (Fiado)</small>
                    <h4 class="fw-bold mb-0" id="dashFiado">R$ 0,00</h4>
                    <span class="badge bg-white text-danger mt-2">Ver Lista ></span>
                </div>
            </div>
            <div class="col-6">
                <div class="card card-dash bg-vista p-3 shadow" onclick="verRelatorio('VISTA')">
                    <small>Caixa (√Ä Vista)</small>
                    <h4 class="fw-bold mb-0" id="dashVista">R$ 0,00</h4>
                    <span class="badge bg-white text-success mt-2">Ver Vendas ></span>
                </div>
            </div>
            <div class="col-12">
                <div class="card card-dash bg-atrasado p-3 shadow" onclick="verRelatorio('ATRASADOS')">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <small class="text-warning">‚ö†Ô∏è Atrasados (+30 dias)</small>
                            <h4 class="fw-bold mb-0 text-white" id="dashAtrasados">Calcular...</h4>
                        </div>
                        <div class="fs-1">üìÖ</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="areaRelatorio" class="mt-4">
            <p class="text-center text-muted small">Toque nos cards acima para ver os detalhes.</p>
        </div>
    </div>

    <div class="tab-pane fade" id="tab-novo">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="mb-3">Cadastrar Novo</h5>
                <label>Nome:</label>
                <input type="text" id="novoNome" class="form-control mb-2" placeholder="Ex: Jo√£o Silva">
                <label>Setor:</label>
                <select id="novoSetor" class="form-select mb-2">
                    <option value="IGREJA">Igreja</option>
                    <option value="ROLETE">Rolete</option>
                    <option value="TABATA">Tabata</option>
                    <option value="ANDERSON">Anderson</option>
                    <option value="BIANCA">Bianca</option>
                    <option value="RUA">Rua/Outros</option>
                </select>
                <label>Telefone:</label>
                <input type="text" id="novoTel" class="form-control mb-3" placeholder="(00) 00000-0000">
                <button class="btn btn-primary w-100" onclick="salvarNovoCliente()">üíæ Salvar Agora</button>
            </div>
        </div>
    </div>

    <div class="tab-pane fade" id="tab-prod">
        <div class="input-group mb-3">
            <input type="text" id="prodNome" class="form-control" placeholder="Nome (Ex: Trufa)">
            <input type="number" id="prodPreco" class="form-control" placeholder="R$">
            <button class="btn btn-success" onclick="addProduto()">+</button>
        </div>
        <ul id="listaProdutos" class="list-group shadow-sm"></ul>
    </div>

    <div class="tab-pane fade" id="tab-config">
        <div class="card border-warning shadow-sm">
            <div class="card-header bg-warning fw-bold">üì• Importar Excel (.xlsx)</div>
            <div class="card-body">
                <p class="small">Selecione o arquivo. O sistema vai ler NOME, TOTAL, TRUFA, etc.</p>
                <input type="file" id="arquivoExcel" class="form-control mb-3" accept=".xlsx, .xls">
                <button class="btn btn-dark w-100" onclick="processarExcel()">Ler Planilha</button>
                <div id="statusImport" class="mt-2 fw-bold text-primary"></div>
            </div>
        </div>
    </div>

</div>

<div class="modal fade" id="modalVenda" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title fw-bold" id="tituloVenda">Venda</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="idClienteVenda">
                
                <div id="boxBloqueio" class="alert alert-danger d-none text-center">
                    <strong>‚õî CLIENTE COM D√çVIDA!</strong><br>
                    Venda bloqueada. Chame o supervisor.<br>
                    <button class="btn btn-sm btn-outline-danger mt-2" onclick="desbloquearComSenha()">Liberar com Senha 0309</button>
                </div>

                <div id="areaVendaInputs">
                    <div class="input-group mb-2">
                        <select id="selectProdVenda" class="form-select"></select>
                        <input type="number" id="qtdProdVenda" class="form-control" value="1" style="max-width: 70px;">
                        <button class="btn btn-primary" onclick="addCarrinho()">‚ûï</button>
                    </div>

                    <ul class="list-group mb-3 bg-light" id="listaCarrinho" style="max-height: 150px; overflow-y: auto;">
                        <li class="list-group-item text-center small text-muted">Carrinho vazio</li>
                    </ul>
                    <h3 class="text-end fw-bold text-primary" id="totalCarrinho">R$ 0,00</h3>

                    <label class="fw-bold mt-2">Como vai ser?</label>
                    <div class="d-flex gap-2 mb-3">
                        <input type="radio" class="btn-check" name="tipoVenda" id="optFiado" value="FIADO" checked>
                        <label class="btn btn-outline-danger w-50" for="optFiado">üî¥ FIADO (Deve)</label>

                        <input type="radio" class="btn-check" name="tipoVenda" id="optVista" value="VISTA">
                        <label class="btn btn-outline-success w-50" for="optVista">üü¢ √Ä VISTA (Pago)</label>
                    </div>
                    <input type="date" id="dataVenda" class="form-control mb-3">
                    
                    <button id="btnFinalizar" class="btn btn-dark w-100 py-2 fs-5" onclick="finalizarVenda()">‚úÖ CONCLUIR</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalPagamento" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">üí∞ Receber D√≠vida</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <input type="hidden" id="idClientePgto">
                <p>Valor do Pagamento:</p>
                <input type="number" id="valorPgto" class="form-control fs-1 text-center text-success fw-bold mb-3" placeholder="0,00">
                <input type="date" id="dataPgto" class="form-control">
                <button class="btn btn-success w-100 mt-3 fw-bold" onclick="confirmarPagamento()">CONFIRMAR RECEBIMENTO</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalExtrato" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Hist√≥rico Completo</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body p-0">
                <table class="table table-striped mb-0 small">
                    <thead class="table-dark"><tr><th>Data</th><th>O que aconteceu?</th><th>Valor</th></tr></thead>
                    <tbody id="tabelaExtrato"></tbody>
                </table>
            </div>
            <div class="modal-footer bg-light">
                <small class="text-muted w-100 text-center">Se houver pagamento parcial, compare o valor da Venda com o valor do Pagamento acima.</small>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalSenha" tabindex="-1" style="z-index: 9999;">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content border-danger">
            <div class="modal-header bg-danger text-white py-1"><h6 class="m-0">üîí Senha do Chefe</h6></div>
            <div class="modal-body">
                <input type="password" id="inputSenha" class="form-control text-center fs-4 mb-2" placeholder="****">
                <button class="btn btn-danger w-100" onclick="validarSenha()">OK</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, query, where, updateDoc, doc, orderBy, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBUFv4jrng5g-0eUT9zjDukZGA46eVH7g0",
    authDomain: "gabydoces-d0cd1.firebaseapp.com",
    projectId: "gabydoces-d0cd1",
    storageBucket: "gabydoces-d0cd1.firebasestorage.app",
    messagingSenderId: "702910388683",
    appId: "1:702910388683:web:28facd97365fb586373e4e"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // VARI√ÅVEIS GLOBAIS
  let CARRINHO = [];
  let TOTAL_CARRINHO = 0;
  let SENHA_CALLBACK = null;
  let BLOQUEIO_ATIVO = false;

  window.onload = () => {
      carregarClientes();
      carregarProdutos();
      // Datas padr√£o Dashboard (M√™s atual)
      const hoje = new Date();
      const primeiroDia = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
      document.getElementById('dataDash1').valueAsDate = primeiroDia;
      document.getElementById('dataDash2').valueAsDate = hoje;
  };

  // --- 1. CLIENTES (CORRIGIDO) ---
  window.carregarClientes = async () => {
      const lista = document.getElementById('listaClientes');
      const busca = document.getElementById('buscaNome').value.toLowerCase();
      const setor = document.getElementById('filtroSetor').value;
      
      lista.innerHTML = '<div class="text-center mt-5"><div class="spinner-border text-danger"></div></div>';

      const q = query(collection(db, "clientes"), orderBy("nome"));
      const snap = await getDocs(q);
      
      lista.innerHTML = '';
      
      snap.forEach(d => {
          const c = d.data();
          if (busca && !c.nome.toLowerCase().includes(busca)) return;
          if (setor && c.setor !== setor) return;

          const saldo = parseFloat(c.saldo) || 0;
          const devedor = saldo < -0.01;
          const statusClass = devedor ? 'status-devendo' : 'status-ok';
          const valorClass = devedor ? 'texto-devendo' : 'texto-ok';
          const textoSaldo = devedor ? `DEVE R$ ${Math.abs(saldo).toFixed(2)}` : `CR√âDITO R$ ${saldo.toFixed(2)}`;

          lista.innerHTML += `
            <div class="col-md-6 mb-2">
                <div class="card shadow-sm card-cliente ${statusClass}">
                    <div class="card-body p-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="fw-bold m-0 text-truncate" style="max-width: 60%;">${c.nome}</h6>
                            <span class="badge bg-secondary" style="font-size:0.6rem">${c.setor}</span>
                        </div>
                        <div class="${valorClass} fs-5 my-1">${textoSaldo}</div>
                        <div class="btn-group w-100">
                            <button class="btn btn-outline-danger btn-sm" onclick="abrirVenda('${d.id}', '${c.nome}', ${saldo})">Vender</button>
                            <button class="btn btn-outline-success btn-sm" onclick="abrirPagamento('${d.id}')">Receber</button>
                            <button class="btn btn-outline-dark btn-sm" onclick="verExtrato('${d.id}')">üìÑ Detalhes</button>
                        </div>
                    </div>
                </div>
            </div>`;
      });
  };

  window.salvarNovoCliente = async () => {
      const nome = document.getElementById('novoNome').value.toUpperCase();
      const setor = document.getElementById('novoSetor').value;
      const tel = document.getElementById('novoTel').value;

      if(!nome) return alert("Digite o nome!");

      // Verifica duplicidade
      const q = query(collection(db, "clientes"), where("nome", "==", nome));
      const check = await getDocs(q);
      if(!check.empty) return alert("Cliente j√° existe!");

      try {
          await addDoc(collection(db, "clientes"), { nome, setor, telefone: tel, saldo: 0 });
          alert("Cliente Salvo!");
          document.getElementById('novoNome').value = '';
          // Volta pra aba inicio
          document.querySelector('[data-bs-target="#tab-inicio"]').click();
          carregarClientes();
      } catch(e) {
          alert("Erro ao salvar: " + e.message);
      }
  };

  // --- 2. IMPORTA√á√ÉO EXCEL (CORRIGIDO PARA ARRAY BUFFER) ---
  window.processarExcel = () => {
      const fileInput = document.getElementById('arquivoExcel');
      if(!fileInput.files[0]) return alert("Selecione o arquivo!");
      
      const reader = new FileReader();
      reader.onload = async (e) => {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, {type: 'array'}); // Leitura bin√°ria correta
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const dados = XLSX.utils.sheet_to_json(sheet);
          
          let novos = 0;
          document.getElementById('statusImport').innerText = "Importando... aguarde...";

          for(let row of dados) {
              const nome = row['NOME'];
              if(!nome) continue;
              
              // Verifica exist√™ncia
              const q = query(collection(db, "clientes"), where("nome", "==", nome.toUpperCase()));
              const check = await getDocs(q);
              
              if(check.empty) {
                  // L√™ TOTAL (d√≠vida)
                  let total = row['TOTAL'];
                  if(typeof total === 'string') total = parseFloat(total.replace('R$','').replace(',','.'));
                  if(!total) total = 0;
                  const saldo = total > 0 ? -Math.abs(total) : 0;

                  const ref = await addDoc(collection(db, "clientes"), {
                      nome: nome.toUpperCase(),
                      setor: (row['SETOR'] || 'GERAL').toUpperCase(),
                      telefone: row['TELEFONE'] || '',
                      saldo: saldo
                  });
                  
                  // Se tiver d√≠vida, cria hist√≥rico inicial
                  if(saldo < 0) {
                      await addDoc(collection(db, "transacoes"), {
                          cliente_id: ref.id,
                          tipo: 'VENDA',
                          metodo: 'FIADO',
                          valor: Math.abs(saldo),
                          descricao: 'Saldo Importado Planilha',
                          data: new Date().toISOString().split('T')[0],
                          timestamp: new Date()
                      });
                  }
                  novos++;
              }
          }
          alert(`Importa√ß√£o conclu√≠da! ${novos} novos clientes.`);
          document.getElementById('statusImport').innerText = "";
          carregarClientes();
      };
      reader.readAsArrayBuffer(fileInput.files[0]);
  };

  // --- 3. VENDAS E CARRINHO ---
  window.abrirVenda = (id, nome, saldo) => {
      CARRINHO = [];
      TOTAL_CARRINHO = 0;
      atualizarCarrinho();
      document.getElementById('idClienteVenda').value = id;
      document.getElementById('tituloVenda').innerText = `Venda: ${nome}`;
      document.getElementById('dataVenda').valueAsDate = new Date();
      
      // BLOQUEIO CALOTEIRO
      if (saldo < -1) {
          BLOQUEIO_ATIVO = true;
          document.getElementById('boxBloqueio').classList.remove('d-none');
          document.getElementById('areaVendaInputs').classList.add('d-none');
      } else {
          BLOQUEIO_ATIVO = false;
          document.getElementById('boxBloqueio').classList.add('d-none');
          document.getElementById('areaVendaInputs').classList.remove('d-none');
      }
      
      new bootstrap.Modal(document.getElementById('modalVenda')).show();
  };

  window.desbloquearComSenha = () => {
      pedirSenha(() => {
          BLOQUEIO_ATIVO = false;
          document.getElementById('boxBloqueio').classList.add('d-none');
          document.getElementById('areaVendaInputs').classList.remove('d-none');
      });
  };

  window.addCarrinho = () => {
      const select = document.getElementById('selectProdVenda');
      const qtd = parseFloat(document.getElementById('qtdProdVenda').value);
      const preco = parseFloat(select.value);
      const nome = select.options[select.selectedIndex].getAttribute('data-nome');

      if(!nome) return;
      
      CARRINHO.push({ nome, qtd, total: preco * qtd });
      TOTAL_CARRINHO += (preco * qtd);
      atualizarCarrinho();
  };

  function atualizarCarrinho() {
      const lista = document.getElementById('listaCarrinho');
      lista.innerHTML = '';
      CARRINHO.forEach((item, idx) => {
          lista.innerHTML += `<li class="list-group-item d-flex justify-content-between p-1 small">${item.qtd}x ${item.nome} <span>R$ ${item.total.toFixed(2)} <a href="#" class="text-danger" onclick="removeitem(${idx})">x</a></span></li>`;
      });
      document.getElementById('totalCarrinho').innerText = `R$ ${TOTAL_CARRINHO.toFixed(2)}`;
  }

  window.finalizarVenda = async () => {
      if(CARRINHO.length === 0) return alert("Carrinho vazio!");
      
      const id = document.getElementById('idClienteVenda').value;
      const tipo = document.querySelector('input[name="tipoVenda"]:checked').value;
      const data = document.getElementById('dataVenda').value;

      // Descri√ß√£o detalhada para o Extrato
      const descProdutos = CARRINHO.map(i => `${i.qtd}x ${i.nome}`).join(', ');
      
      // Se for FIADO, abate saldo. Se VISTA, n√£o.
      if (tipo === 'FIADO') {
          const ref = doc(db, "clientes", id);
          const snap = await getDoc(ref);
          const saldoAtual = snap.data().saldo || 0;
          await updateDoc(ref, { saldo: saldoAtual - TOTAL_CARRINHO });
      }

      await addDoc(collection(db, "transacoes"), {
          cliente_id: id,
          tipo: 'VENDA',
          metodo: tipo,
          valor: TOTAL_CARRINHO,
          descricao: descProdutos, // AQUI FICA O DETALHE DO PRODUTO
          data: data,
          timestamp: new Date()
      });

      bootstrap.Modal.getInstance(document.getElementById('modalVenda')).hide();
      carregarClientes();
      alert("Venda realizada!");
  };

  // --- 4. PAGAMENTO E EXTRATO ---
  window.abrirPagamento = (id) => {
      document.getElementById('idClientePgto').value = id;
      document.getElementById('valorPgto').value = '';
      document.getElementById('dataPgto').valueAsDate = new Date();
      new bootstrap.Modal(document.getElementById('modalPagamento')).show();
  };

  window.confirmarPagamento = async () => {
      const id = document.getElementById('idClientePgto').value;
      const valor = parseFloat(document.getElementById('valorPgto').value);
      const data = document.getElementById('dataPgto').value;
      
      if(!valor) return alert("Digite valor!");

      const ref = doc(db, "clientes", id);
      const snap = await getDoc(ref);
      const saldoAtual = snap.data().saldo || 0;

      await updateDoc(ref, { saldo: saldoAtual + valor });
      await addDoc(collection(db, "transacoes"), {
          cliente_id: id,
          tipo: 'PAGAMENTO',
          metodo: 'DINHEIRO',
          valor: valor,
          descricao: 'Pagamento Parcial/Total',
          data: data,
          timestamp: new Date()
      });
      bootstrap.Modal.getInstance(document.getElementById('modalPagamento')).hide();
      carregarClientes();
      alert("Recebido!");
  };

  window.verExtrato = async (id) => {
      const q = query(collection(db, "transacoes"), where("cliente_id", "==", id), orderBy("timestamp", "desc"));
      const snap = await getDocs(q);
      const tb = document.getElementById('tabelaExtrato');
      tb.innerHTML = '';
      
      snap.forEach(d => {
          const t = d.data();
          const isPgto = t.tipo === 'PAGAMENTO';
          const cor = isPgto ? 'text-success' : 'text-danger';
          const sinal = isPgto ? '+' : '-';
          const dataBR = t.data.split('-').reverse().join('/');
          
          // Se for venda a vista, mostramos mas n√£o afeta saldo visualmente como d√≠vida
          const obs = t.metodo === 'VISTA' ? ' (√Ä Vista)' : '';

          tb.innerHTML += `
            <tr>
                <td>${dataBR}</td>
                <td>
                    <strong>${t.tipo}${obs}</strong><br>
                    <small class="text-muted">${t.descricao}</small>
                </td>
                <td class="${cor} fw-bold text-end">${sinal} R$ ${t.valor.toFixed(2)}</td>
            </tr>`;
      });
      new bootstrap.Modal(document.getElementById('modalExtrato')).show();
  };

  // --- 5. DASHBOARD INTERATIVO (NOVO) ---
  window.carregarDashboard = async () => {
      // 1. Calcular Totais
      const d1 = document.getElementById('dataDash1').value;
      const d2 = document.getElementById('dataDash2').value;
      
      const q = query(collection(db, "transacoes"));
      const snap = await getDocs(q);
      
      let fiado = 0, vista = 0;
      snap.forEach(d => {
          const t = d.data();
          if(t.data >= d1 && t.data <= d2 && t.tipo === 'VENDA') {
              if(t.metodo === 'FIADO') fiado += t.valor;
              if(t.metodo === 'VISTA') vista += t.valor;
          }
      });
      
      document.getElementById('dashFiado').innerText = `R$ ${fiado.toFixed(2)}`;
      document.getElementById('dashVista').innerText = `R$ ${vista.toFixed(2)}`;
      document.getElementById('areaRelatorio').innerHTML = '<p class="text-center mt-3 text-muted">Selecione um card acima.</p>';
      
      // Calcular Atrasados (Simples: Clientes com saldo < 0 e √∫ltima compra > 30 dias)
      // Nota: Isso √© uma estimativa. Para precis√£o exata precisaria de query complexa.
      // Aqui vamos contar quantos clientes devem.
      const qC = query(collection(db, "clientes"));
      const snapC = await getDocs(qC);
      let countAtrasados = 0;
      snapC.forEach(d => {
          if(d.data().saldo < -1) countAtrasados++; // Quem deve
      });
      document.getElementById('dashAtrasados').innerText = `${countAtrasados} Clientes`;
  };

  window.verRelatorio = async (tipo) => {
      const area = document.getElementById('areaRelatorio');
      area.innerHTML = '<div class="spinner-border text-primary"></div> Carregando lista...';
      
      let html = '<ul class="list-group">';
      
      if (tipo === 'DEVEDORES' || tipo === 'ATRASADOS') {
          // Lista de quem deve
          const q = query(collection(db, "clientes"), orderBy("nome"));
          const snap = await getDocs(q);
          
          snap.forEach(d => {
              const c = d.data();
              if (c.saldo < -0.01) {
                  html += `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${c.nome}</strong><br>
                            <span class="badge bg-secondary">${c.setor}</span>
                        </div>
                        <span class="text-danger fw-bold">Deve R$ ${Math.abs(c.saldo).toFixed(2)}</span>
                    </li>`;
              }
          });
      } else if (tipo === 'VISTA') {
          // Lista de Vendas √† Vista no periodo
          const d1 = document.getElementById('dataDash1').value;
          const d2 = document.getElementById('dataDash2').value;
          const q = query(collection(db, "transacoes"), where("metodo", "==", "VISTA"), orderBy("data", "desc"));
          const snap = await getDocs(q);
          
          snap.forEach(d => {
              const t = d.data();
              if(t.data >= d1 && t.data <= d2) {
                  html += `
                    <li class="list-group-item">
                        <div class="d-flex justify-content-between">
                            <strong>${t.data.split('-').reverse().join('/')}</strong>
                            <span class="text-success fw-bold">R$ ${t.valor.toFixed(2)}</span>
                        </div>
                        <small class="text-muted">${t.descricao}</small>
                    </li>`;
              }
          });
      }
      html += '</ul>';
      area.innerHTML = html;
  };

  // --- 6. PRODUTOS E SENHA ---
  window.pedirSenha = (callback) => {
      SENHA_CALLBACK = callback;
      document.getElementById('inputSenha').value = '';
      new bootstrap.Modal(document.getElementById('modalSenha')).show();
  };
  window.validarSenha = () => {
      if(document.getElementById('inputSenha').value === '0309') {
          bootstrap.Modal.getInstance(document.getElementById('modalSenha')).hide();
          if(SENHA_CALLBACK) SENHA_CALLBACK();
      } else {
          alert("Senha incorreta!");
      }
  };

  window.carregarProdutos = async () => {
      const lista = document.getElementById('listaProdutos');
      const select = document.getElementById('selectProdVenda');
      const q = query(collection(db, "produtos"));
      const snap = await getDocs(q);
      
      lista.innerHTML = '';
      select.innerHTML = '';
      
      snap.forEach(d => {
          const p = d.data();
          select.innerHTML += `<option value="${p.preco}" data-nome="${p.nome}">${p.nome} (R$ ${p.preco})</option>`;
          lista.innerHTML += `<li class="list-group-item d-flex justify-content-between">${p.nome} <span>R$ ${p.preco}</span></li>`;
      });
  };

  window.addProduto = async () => {
      const nome = document.getElementById('prodNome').value.toUpperCase();
      const preco = parseFloat(document.getElementById('prodPreco').value);
      if(nome && preco) {
          await addDoc(collection(db, "produtos"), { nome, preco });
          document.getElementById('prodNome').value = '';
          document.getElementById('prodPreco').value = '';
          carregarProdutos();
      }
  };

</script>
</body>
</html>
