<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gaby Doces - V17.0 (Ciclo Inteligente)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <style>
        body { background-color: #f8f9fa; padding-bottom: 100px; font-family: sans-serif; }
        .nav-pills .nav-link.active { background-color: #d63384; color: white; font-weight: bold; }
        .nav-pills .nav-link { background: white; color: #666; margin: 0 2px; border: 1px solid #ddd; }
        
        .card-cliente { border-left: 5px solid #ccc; transition: 0.2s; }
        .status-devendo { border-left-color: #dc3545; background-color: #fff5f5; }
        .status-ok { border-left-color: #198754; background-color: #fff; }
        .texto-devendo { color: #dc3545; font-weight: 800; }
        .texto-ok { color: #198754; font-weight: 800; }

        .card-dash { cursor: pointer; color: white; border: none; }
        .bg-hoje { background: linear-gradient(135deg, #fce38a, #f38181); color: #333; }
        .bg-atrasado { background: linear-gradient(135deg, #ff416c, #ff4b2b); }
        .bg-prazo { background: linear-gradient(135deg, #00b09b, #96c93d); }
    </style>
</head>
<body>

<div class="container mt-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="fw-bold text-secondary m-0">üç¨ Gaby Doces <span class="badge bg-primary small">V17.0 Ciclo</span></h5>
        <button class="btn btn-sm btn-light border" onclick="location.reload()">üîÑ F5</button>
    </div>

    <ul class="nav nav-pills nav-fill mb-4" id="menuPrincipal" role="tablist">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-inicio">üè† Clientes</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-dash" onclick="carregarDashboard()">üìÖ Cobran√ßa</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-novo">üë§ Novo</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-prod">üì¶ Prod</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-config">‚öôÔ∏è Excel</button></li>
    </ul>
</div>

<div class="tab-content container">

    <div class="tab-pane fade show active" id="tab-inicio">
        <div class="input-group mb-3">
            <input type="text" id="buscaNome" class="form-control" placeholder="üîç Buscar..." onkeyup="carregarClientes()">
            <select id="filtroSetor" class="form-select" style="max-width: 130px;" onchange="carregarClientes()">
                <option value="">Setor</option>
                <option value="IGREJA">Igreja</option>
                <option value="ROLETE">Rolete</option>
                <option value="TABATA">Tabata</option>
                <option value="ANDERSON">Anderson</option>
                <option value="BIANCA">Bianca</option>
                <option value="RUA">Rua</option>
            </select>
        </div>
        <div id="listaClientes" class="row pb-5">
            <div class="text-center mt-5"><div class="spinner-border text-primary"></div></div>
        </div>
    </div>

    <div class="tab-pane fade" id="tab-dash">
        <h6 class="text-muted fw-bold mb-3">Cobran√ßa Mensal Autom√°tica</h6>
        <div class="row g-2">
            <div class="col-12">
                <div class="card card-dash bg-hoje p-3 shadow" onclick="filtrarRelatorio('HOJE')">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="fw-bold m-0">üü° VENCE HOJE</h5>
                            <small>Cobrar Agora</small>
                        </div>
                        <h3 class="fw-bold m-0" id="cntHoje">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="card card-dash bg-atrasado p-3 shadow" onclick="filtrarRelatorio('ATRASADO')">
                    <small>üî¥ Atrasados</small>
                    <h4 class="fw-bold m-0" id="cntAtrasados">0</h4>
                </div>
            </div>
            <div class="col-6">
                <div class="card card-dash bg-prazo p-3 shadow" onclick="filtrarRelatorio('PRAZO')">
                    <small>üîµ M√™s que vem</small>
                    <h4 class="fw-bold m-0" id="cntPrazo">0</h4>
                </div>
            </div>
        </div>
        <div id="areaRelatorio" class="mt-4">
            <p class="text-center text-muted small">Clique nos cart√µes para ver.</p>
        </div>
    </div>

    <div class="tab-pane fade" id="tab-novo">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5>Cadastrar Novo</h5>
                <input type="text" id="novoNome" class="form-control mb-2" placeholder="Nome Completo">
                <select id="novoSetor" class="form-select mb-2">
                    <option value="IGREJA">Igreja</option>
                    <option value="ROLETE">Rolete</option>
                    <option value="TABATA">Tabata</option>
                    <option value="ANDERSON">Anderson</option>
                    <option value="BIANCA">Bianca</option>
                    <option value="RUA">Rua/Outros</option>
                </select>
                <input type="text" id="novoTel" class="form-control mb-2" placeholder="Telefone (com DDD)">
                
                <label class="small text-muted fw-bold">Paga todo dia:</label>
                <select id="novoDiaPag" class="form-select mb-3">
                    <option value="">Sem dia fixo</option>
                    </select>
                
                <button class="btn btn-primary w-100" onclick="salvarNovoCliente()">üíæ Salvar Cliente</button>
            </div>
        </div>
    </div>

    <div class="tab-pane fade" id="tab-prod">
        <div class="input-group mb-3">
            <input type="text" id="prodNome" class="form-control" placeholder="Produto">
            <input type="number" id="prodPreco" class="form-control" placeholder="R$">
            <button class="btn btn-success" onclick="addProduto()">Add</button>
        </div>
        <small class="text-muted d-block mb-2">Clique no produto para Editar ou Excluir.</small>
        <ul id="listaProdutos" class="list-group shadow-sm"></ul>
    </div>

    <div class="tab-pane fade" id="tab-config">
        <div class="card border-warning shadow-sm">
            <div class="card-header bg-warning fw-bold">üì• Importar Excel</div>
            <div class="card-body">
                <input type="file" id="arquivoExcel" class="form-control mb-3" accept=".xlsx, .xls">
                <button class="btn btn-dark w-100" onclick="processarExcel()">Ler Planilha</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalVenda" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title fw-bold" id="tituloVenda">Venda</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="idClienteVenda">
                
                <div id="boxBloqueio" class="alert alert-danger d-none text-center p-2">
                    <strong>‚õî DEVEDOR ATRASADO!</strong><br>
                    <button class="btn btn-sm btn-outline-danger mt-2" onclick="desbloquearComSenha()">Liberar c/ Senha 0309</button>
                </div>

                <div id="areaVendaInputs">
                    <div class="input-group mb-2">
                        <select id="selectProdVenda" class="form-select"></select>
                        <input type="number" id="qtdProdVenda" class="form-control" value="1" style="max-width: 60px;">
                        <button class="btn btn-primary" onclick="addCarrinho()">‚ûï</button>
                    </div>
                    
                    <label class="small text-muted fw-bold">Carrinho:</label>
                    <ul class="list-group mb-2 bg-light" id="listaCarrinho" style="max-height: 150px; overflow-y: auto;">
                        <li class="list-group-item text-center small text-muted">Carrinho vazio</li>
                    </ul>
                    <h4 class="text-end fw-bold text-primary" id="totalCarrinho">R$ 0,00</h4>
                    
                    <div class="d-flex gap-2 mb-3 mt-3">
                        <input type="radio" class="btn-check" name="tipoVenda" id="optFiado" value="FIADO" checked>
                        <label class="btn btn-outline-danger w-50" for="optFiado">üî¥ FIADO</label>
                        <input type="radio" class="btn-check" name="tipoVenda" id="optVista" value="VISTA">
                        <label class="btn btn-outline-success w-50" for="optVista">üü¢ √Ä VISTA</label>
                    </div>
                    
                    <label class="small text-muted">Data da Venda:</label>
                    <input type="date" id="dataVenda" class="form-control mb-2">
                    <button class="btn btn-dark w-100 py-2" onclick="finalizarVenda()">‚úÖ CONCLUIR</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalPagamento" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">üí∞ Receber</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <input type="hidden" id="idClientePgto">
                <p class="mb-1">Valor recebido:</p>
                <input type="number" id="valorPgto" class="form-control fs-1 text-center text-success fw-bold mb-3" placeholder="0,00">
                <input type="date" id="dataPgto" class="form-control">
                <button class="btn btn-success w-100 mt-3 fw-bold" onclick="confirmarPagamento()">CONFIRMAR</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalExtrato" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title">üìú Hist√≥rico</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <table class="table table-striped mb-0 table-sm align-middle" style="font-size: 0.9rem;">
                    <thead class="table-dark">
                        <tr>
                            <th style="width: 20%">Data</th>
                            <th style="width: 50%">Descri√ß√£o</th>
                            <th style="width: 20%" class="text-end">Valor</th>
                            <th style="width: 10%">A√ß√£o</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaExtrato"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEditarCliente" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title">‚úèÔ∏è Editar Cliente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editId">
                <label>Nome:</label>
                <input type="text" id="editNome" class="form-control mb-2">
                <label>Setor:</label>
                <select id="editSetor" class="form-select mb-2">
                    <option value="IGREJA">Igreja</option>
                    <option value="ROLETE">Rolete</option>
                    <option value="TABATA">Tabata</option>
                    <option value="ANDERSON">Anderson</option>
                    <option value="BIANCA">Bianca</option>
                    <option value="RUA">Rua/Outros</option>
                </select>
                <label>Telefone:</label>
                <input type="text" id="editTel" class="form-control mb-2">
                <label>Dia de Pagamento (Todo m√™s):</label>
                <select id="editDiaPag" class="form-select mb-3">
                    <option value="">Sem dia fixo</option>
                    </select>
                
                <button class="btn btn-dark w-100" onclick="salvarEdicaoCliente()">Salvar Altera√ß√µes</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEditarProd" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title">Editar Produto</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editProdId">
                <label>Nome:</label>
                <input type="text" id="editProdNome" class="form-control mb-2">
                <label>Pre√ßo:</label>
                <input type="number" id="editProdPreco" class="form-control mb-3">
                <div class="d-flex gap-2">
                    <button class="btn btn-primary flex-grow-1" onclick="salvarEdicaoProd()">Salvar</button>
                    <button class="btn btn-danger" onclick="excluirProd()">üóëÔ∏è</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalSenha" tabindex="-1" style="z-index: 1080;">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content border-danger">
            <div class="modal-body text-center">
                <strong class="text-danger">üîí SENHA CHEFE:</strong>
                <input type="password" id="inputSenha" class="form-control text-center fs-4 my-2" placeholder="****">
                <button class="btn btn-danger w-100" onclick="validarSenha()">OK</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, query, where, updateDoc, doc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBUFv4jrng5g-0eUT9zjDukZGA46eVH7g0",
    authDomain: "gabydoces-d0cd1.firebaseapp.com",
    projectId: "gabydoces-d0cd1",
    storageBucket: "gabydoces-d0cd1.firebasestorage.app",
    messagingSenderId: "702910388683",
    appId: "1:702910388683:web:28facd97365fb586373e4e"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let CARRINHO = [];
  let TOTAL_CARRINHO = 0;
  let SENHA_CALLBACK = null;

  window.onload = () => {
      preencherDias();
      carregarClientes();
      carregarProdutos();
      document.getElementById('dataVenda').valueAsDate = new Date();
  };

  function preencherDias() {
      const sels = [document.getElementById('novoDiaPag'), document.getElementById('editDiaPag')];
      sels.forEach(s => {
          for(let i=1; i<=31; i++) {
              s.innerHTML += `<option value="${i}">Dia ${i}</option>`;
          }
      });
  }

  // --- FUN√á√ÉO INTELIGENTE DE C√ÅLCULO DE DATA ---
  function calcularVencimento(diaPagamento, dataUltimaCompraISO) {
      if (!diaPagamento) return null;
      
      const hoje = new Date();
      hoje.setHours(0,0,0,0);
      
      let dataRef;
      if (dataUltimaCompraISO) {
          // Usa a data da compra como refer√™ncia
          dataRef = new Date(dataUltimaCompraISO + 'T00:00:00');
      } else {
          // Se n√£o tem compra registrada, usa hoje
          dataRef = new Date();
      }

      // Cria a data de vencimento no m√™s da compra
      let vencimento = new Date(dataRef.getFullYear(), dataRef.getMonth(), diaPagamento);

      // A M√ÅGICA: Se comprou DEPOIS do dia do pagamento, vence no m√™s seguinte
      if (dataRef.getDate() > diaPagamento) {
          vencimento.setMonth(vencimento.getMonth() + 1);
      }
      
      // Ajuste se virou ano ou m√™s com menos dias
      if (vencimento.getDate() !== diaPagamento) {
          // Ex: dia 30 de fevereiro n√£o existe, JS joga pra mar√ßo. Mantemos assim ou ajustamos?
          // O JS nativo ajusta bem (ex: 31 jan + 1 m√™s = 3 mar ou 28 fev dependendo do ano)
      }

      return vencimento;
  }

  function obterEstadoVencimento(vencimento) {
      if (!vencimento) return 'SEM_DATA';
      
      const hoje = new Date();
      hoje.setHours(0,0,0,0);
      const venc = new Date(vencimento);
      venc.setHours(0,0,0,0);

      if (venc.getTime() === hoje.getTime()) return 'HOJE';
      if (venc.getTime() < hoje.getTime()) return 'ATRASADO';
      return 'PRAZO';
  }

  // 1. CLIENTES (L√ìGICA DO DIA DO M√äS)
  window.carregarClientes = async () => {
      const lista = document.getElementById('listaClientes');
      const busca = document.getElementById('buscaNome').value.toLowerCase();
      const setor = document.getElementById('filtroSetor').value;
      
      lista.innerHTML = '<div class="text-center mt-5"><div class="spinner-border text-primary"></div></div>';
      
      const q = query(collection(db, "clientes"));
      const snap = await getDocs(q);
      
      let clientes = [];
      snap.forEach(d => clientes.push({id: d.id, ...d.data()}));
      clientes.sort((a,b) => a.nome.localeCompare(b.nome));

      lista.innerHTML = '';
      
      clientes.forEach(c => {
          if (busca && !c.nome.toLowerCase().includes(busca)) return;
          if (setor && c.setor !== setor) return;

          const saldo = parseFloat(c.saldo) || 0;
          const devedor = saldo < -0.01;
          const diaPag = parseInt(c.dia_pagamento) || 0;
          
          let cardColor = 'status-ok';
          let textColor = 'texto-ok';
          let badge = '';
          let tipoZap = 'GERAL';
          let textoZapData = '';

          if (devedor) {
              cardColor = 'status-devendo';
              textColor = 'texto-devendo';
              
              if (diaPag > 0) {
                  // C√ÅLCULO INTELIGENTE
                  const dataVenc = calcularVencimento(diaPag, c.ultima_venda);
                  const estado = obterEstadoVencimento(dataVenc);
                  const dataFormatada = dataVenc.toLocaleDateString('pt-BR');
                  textoZapData = dataFormatada;

                  if (estado === 'ATRASADO') {
                      badge = `<span class="badge bg-danger w-100 mb-2">üî¥ VENCIDO (${dataFormatada})</span>`;
                      tipoZap = 'ATRASADO';
                  } else if (estado === 'HOJE') {
                      badge = `<span class="badge bg-warning text-dark w-100 mb-2">üü° VENCE HOJE!</span>`;
                      tipoZap = 'HOJE';
                  } else {
                      badge = `<span class="badge bg-info text-dark w-100 mb-2">üîµ Vence: ${dataFormatada}</span>`;
                      tipoZap = 'PRAZO';
                  }
              } else {
                  badge = `<span class="badge bg-secondary w-100 mb-2">‚ö™ Sem dia fixo</span>`;
              }
          }

          const txtSaldo = devedor ? `DEVE R$ ${Math.abs(saldo).toFixed(2)}` : `CR√âDITO R$ ${saldo.toFixed(2)}`;
          
          let btnZap = '';
          if (devedor) {
              btnZap = `<button class="btn btn-success btn-sm w-100 mt-1" onclick="enviarZap('${c.nome}', '${c.telefone}', ${Math.abs(saldo)}, '${tipoZap}', '${textoZapData}')"><i class="bi bi-whatsapp"></i> Cobrar</button>`;
          }

          lista.innerHTML += `
            <div class="col-md-6 mb-2">
                <div class="card shadow-sm card-cliente ${cardColor}">
                    <div class="card-body p-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="fw-bold text-truncate m-0" style="max-width: 65%">${c.nome}</h6>
                            <button class="btn btn-sm text-secondary border-0" onclick="abrirEditarCliente('${c.id}')">‚úèÔ∏è</button>
                        </div>
                        <span class="badge bg-secondary mb-1" style="font-size: 0.7rem">${c.setor}</span>
                        ${badge}
                        <div class="${textColor} fs-5 mb-1 text-center">
                            ${txtSaldo}
                        </div>
                        <div class="d-flex gap-1 mt-2">
                            <button class="btn btn-outline-danger btn-sm w-100" onclick="abrirVenda('${c.id}', '${c.nome}', ${saldo})">Vender</button>
                            <button class="btn btn-outline-success btn-sm w-100" onclick="abrirPagamento('${c.id}')">Receber</button>
                        </div>
                        ${btnZap}
                        <div class="text-end mt-1">
                            <button class="btn btn-link btn-sm text-decoration-none text-muted" onclick="verExtrato('${c.id}')">üìÑ Detalhes</button>
                        </div>
                    </div>
                </div>
            </div>`;
      });
  };

  // 2. WHATSAPP AUTOM√ÅTICO
  window.enviarZap = (nome, telefone, valor, tipo, dataTxt) => {
      if(!telefone || telefone.length < 8) return alert("Cliente sem telefone cadastrado!");
      const num = telefone.replace(/\D/g, '');
      const telFinal = num.length <= 11 ? "55" + num : num;

      let msg = "";
      if (tipo === 'HOJE') {
          msg = `Ol√° ${nome}, tudo bem? Passando pra lembrar do vencimento hoje no valor de R$ ${valor.toFixed(2)}  Este √© meu PIX 16988143766.`;
      } else if (tipo === 'ATRASADO') {
          msg = `Ol√° ${nome}, constou uma pend√™ncia aqui de R$ ${valor.toFixed(2)}. Podemos agendar o pagamento? vou deixa meu  PIX 16988143766.`;
      } else {
          msg = `Ol√° ${nome}, tudo bem? Sobre seu saldo na Gaby Doces de R$ ${valor.toFixed(2)}... Este √© meu PIX 16988143766.`;
      }

      const url = `https://wa.me/${telFinal}?text=${encodeURIComponent(msg)}`;
      window.open(url, '_blank');
  };

  // 3. DASHBOARD INTELIGENTE
  window.filtrarRelatorio = async (tipo) => {
      const a = document.getElementById('areaRelatorio'); a.innerHTML='Carregando...';
      const q = query(collection(db, "clientes")); const snap = await getDocs(q);
      
      let html = '<ul class="list-group">';
      snap.forEach(d => { 
          const c = d.data(); 
          if(c.saldo < -0.01 && c.dia_pagamento) { 
              const diaPag = parseInt(c.dia_pagamento);
              const dataVenc = calcularVencimento(diaPag, c.ultima_venda);
              const estado = obterEstadoVencimento(dataVenc);
              
              if(tipo === estado) {
                  const btn = `<button class="btn btn-success btn-sm" onclick="enviarZap('${c.nome}','${c.telefone}',${Math.abs(c.saldo)},'${tipo}')"><i class="bi bi-whatsapp"></i></button>`;
                  html+=`<li class="list-group-item d-flex justify-content-between align-items-center">
                      <div><strong>${c.nome}</strong><br><small>Vence: ${dataVenc.toLocaleDateString('pt-BR')}</small></div>
                      <div class="d-flex align-items-center gap-2">
                        <span class="text-danger fw-bold">R$ ${Math.abs(c.saldo).toFixed(2)}</span>
                        ${btn}
                      </div>
                  </li>`; 
              }
          } 
      }); 
      html+='</ul>'; a.innerHTML=html; 
  };
  
  window.carregarDashboard = async () => { 
      const q=query(collection(db,"clientes")); const snap=await getDocs(q); 
      let h=0, a=0, p=0; 
      snap.forEach(d=>{ 
          const c=d.data(); 
          if(c.saldo<-0.01 && c.dia_pagamento) { 
              const diaPag = parseInt(c.dia_pagamento);
              const dataVenc = calcularVencimento(diaPag, c.ultima_venda);
              const estado = obterEstadoVencimento(dataVenc);
              
              if(estado==='HOJE') h++;
              if(estado==='ATRASADO') a++;
              if(estado==='PRAZO') p++;
          } 
      }); 
      document.getElementById('cntHoje').innerText=h; 
      document.getElementById('cntAtrasados').innerText=a; 
      document.getElementById('cntPrazo').innerText=p; 
  };

  // 4. M√âTODOS PADR√ÉO MANTIDOS
  window.salvarNovoCliente = async () => { 
      const nome=document.getElementById('novoNome').value.toUpperCase(); 
      const setor=document.getElementById('novoSetor').value; 
      const tel=document.getElementById('novoTel').value; 
      const diaPag=document.getElementById('novoDiaPag').value; 
      
      if(!nome) return alert("Nome!"); 
      const check=await getDocs(query(collection(db,"clientes"),where("nome","==",nome))); 
      if(!check.empty) return alert("Existe!"); 
      
      const ref=await addDoc(collection(db,"clientes"),{nome, setor, telefone:tel, saldo:0, dia_pagamento: diaPag, ultima_venda: new Date().toISOString().split('T')[0]}); 
      await addDoc(collection(db,"transacoes"),{cliente_id:ref.id, tipo:'INFO', metodo:'SIS', valor:0, descricao:'Inicio', data:new Date().toISOString().split('T')[0], timestamp:new Date()}); 
      alert("Salvo!"); document.querySelector('[data-bs-target="#tab-inicio"]').click(); carregarClientes(); 
  };

  window.abrirEditarCliente = async (id) => { 
      pedirSenha(async () => { 
          const docRef = doc(db, "clientes", id); 
          const snap = await getDoc(docRef); 
          const c = snap.data(); 
          document.getElementById('editId').value = id; 
          document.getElementById('editNome').value = c.nome; 
          document.getElementById('editSetor').value = c.setor; 
          document.getElementById('editTel').value = c.telefone; 
          document.getElementById('editDiaPag').value = c.dia_pagamento || ''; 
          new bootstrap.Modal(document.getElementById('modalEditarCliente')).show(); 
      }); 
  };

  window.salvarEdicaoCliente = async () => { 
      const id = document.getElementById('editId').value; 
      await updateDoc(doc(db, "clientes", id), { 
          nome: document.getElementById('editNome').value.toUpperCase(), 
          setor: document.getElementById('editSetor').value, 
          telefone: document.getElementById('editTel').value, 
          dia_pagamento: document.getElementById('editDiaPag').value 
      }); 
      bootstrap.Modal.getInstance(document.getElementById('modalEditarCliente')).hide(); 
      carregarClientes(); 
      alert("Cliente atualizado!"); 
  };

  window.carregarProdutos = async () => { const s = document.getElementById('selectProdVenda'); const l = document.getElementById('listaProdutos'); const q = query(collection(db, "produtos")); const snap = await getDocs(q); s.innerHTML = ''; l.innerHTML = ''; snap.forEach(d => { const p = d.data(); s.innerHTML += `<option value="${p.preco}" data-nome="${p.nome}">${p.nome} (R$${p.preco})</option>`; l.innerHTML += `<li class="list-group-item d-flex justify-content-between action-hover" style="cursor:pointer" onclick="abrirEditarProd('${d.id}', '${p.nome}', ${p.preco})">${p.nome} <span>R$ ${p.preco} ‚úèÔ∏è</span></li>`; }); };
  window.abrirEditarProd = (id, nome, preco) => { document.getElementById('editProdId').value = id; document.getElementById('editProdNome').value = nome; document.getElementById('editProdPreco').value = preco; new bootstrap.Modal(document.getElementById('modalEditarProd')).show(); };
  window.salvarEdicaoProd = async () => { pedirSenha(async () => { const id = document.getElementById('editProdId').value; const nome = document.getElementById('editProdNome').value.toUpperCase(); const preco = parseFloat(document.getElementById('editProdPreco').value); await updateDoc(doc(db, "produtos", id), { nome, preco }); bootstrap.Modal.getInstance(document.getElementById('modalEditarProd')).hide(); carregarProdutos(); }); };
  window.excluirProd = async () => { pedirSenha(async () => { const id = document.getElementById('editProdId').value; await deleteDoc(doc(db, "produtos", id)); bootstrap.Modal.getInstance(document.getElementById('modalEditarProd')).hide(); carregarProdutos(); }); };
  window.addProduto = async () => { const n = document.getElementById('prodNome').value.toUpperCase(); const p = parseFloat(document.getElementById('prodPreco').value); if(n && p) { await addDoc(collection(db, "produtos"), {nome: n, preco: p}); carregarProdutos(); document.getElementById('prodNome').value = ''; document.getElementById('prodPreco').value = ''; } };
  window.addCarrinho = () => { const select = document.getElementById('selectProdVenda'); const qtd = parseFloat(document.getElementById('qtdProdVenda').value); const preco = parseFloat(select.value); const nome = select.options[select.selectedIndex].getAttribute('data-nome'); if(!nome) return; CARRINHO.push({ nome, qtd, total: preco * qtd }); TOTAL_CARRINHO += preco * qtd; atualizarCarrinho(); };
  window.removerItemCarrinho = (index) => { TOTAL_CARRINHO -= CARRINHO[index].total; CARRINHO.splice(index, 1); atualizarCarrinho(); };
  function atualizarCarrinho() { const lista = document.getElementById('listaCarrinho'); lista.innerHTML = ''; if (CARRINHO.length === 0) { lista.innerHTML = '<li class="list-group-item text-center small text-muted">Carrinho vazio</li>'; } else { CARRINHO.forEach((i, idx) => { lista.innerHTML += `<li class="list-group-item d-flex justify-content-between align-items-center p-1 small"><div>${i.qtd}x ${i.nome}</div><div><span class="me-2">R$ ${i.total.toFixed(2)}</span><button class="btn btn-sm btn-danger py-0 px-2" onclick="removerItemCarrinho(${idx})">X</button></div></li>`; }); } document.getElementById('totalCarrinho').innerText = `R$ ${TOTAL_CARRINHO.toFixed(2)}`; }
  window.abrirVenda = (id, nome, saldo) => { CARRINHO=[]; TOTAL_CARRINHO=0; atualizarCarrinho(); document.getElementById('idClienteVenda').value=id; document.getElementById('tituloVenda').innerText=`Venda: ${nome}`; const bloq=saldo<-1; document.getElementById('boxBloqueio').classList.toggle('d-none',!bloq); document.getElementById('areaVendaInputs').classList.toggle('d-none',bloq); new bootstrap.Modal(document.getElementById('modalVenda')).show(); };
  window.finalizarVenda = async () => { if(!CARRINHO.length) return alert("Carrinho vazio!"); const id = document.getElementById('idClienteVenda').value; const tipo = document.querySelector('input[name="tipoVenda"]:checked').value; let data = document.getElementById('dataVenda').value; if(!data) data = new Date().toISOString().split('T')[0]; const ref = doc(db, "clientes", id); const snap = await getDoc(ref); let saldo = snap.data().saldo || 0; if(tipo === 'FIADO') { saldo -= TOTAL_CARRINHO; await updateDoc(ref, { saldo, ultima_venda: data }); } else { await updateDoc(ref, { ultima_venda: data }); } const desc = CARRINHO.map(i => `${i.qtd}x ${i.nome}`).join(', '); await addDoc(collection(db, "transacoes"), { cliente_id:id, tipo:'VENDA', metodo:tipo, valor:TOTAL_CARRINHO, descricao:desc, data, timestamp:new Date() }); bootstrap.Modal.getInstance(document.getElementById('modalVenda')).hide(); carregarClientes(); alert("Venda OK!"); };
  window.verExtrato = async (id) => { const modal = new bootstrap.Modal(document.getElementById('modalExtrato')); modal.show(); const tb = document.getElementById('tabelaExtrato'); tb.innerHTML = '<tr><td colspan="4" class="text-center"><div class="spinner-border spinner-border-sm text-primary"></div></td></tr>'; try { const q = query(collection(db, "transacoes"), where("cliente_id", "==", id)); const snap = await getDocs(q); let dados = []; snap.forEach(d => dados.push({id: d.id, ...d.data()})); dados.sort((a, b) => new Date(b.timestamp.seconds * 1000) - new Date(a.timestamp.seconds * 1000)); tb.innerHTML = ''; if(dados.length === 0) tb.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Vazio.</td></tr>'; dados.forEach(t => { const dataEx = t.data ? formatarData(t.data) : "??"; const descEx = t.descricao || "-"; const valorEx = t.valor !== undefined ? parseFloat(t.valor).toFixed(2) : "0.00"; const isPgto = t.tipo === 'PAGAMENTO'; const cor = isPgto ? 'text-success' : 'text-danger'; const sinal = isPgto ? '+' : '-'; const extra = t.metodo === 'VISTA' ? ' <span class="badge bg-success" style="font-size:0.6em">VISTA</span>' : ''; tb.innerHTML += `<tr><td>${dataEx}</td><td><div class="fw-bold small">${t.tipo}${extra}</div><div class="text-muted small" style="font-size:0.75rem">${descEx}</div></td><td class="${cor} fw-bold text-end">${sinal}${valorEx}</td><td class="text-center"><button class="btn btn-sm btn-outline-danger border-0" onclick="excluirTransacao('${t.id}', '${id}', ${t.valor}, '${t.tipo}', '${t.metodo}')">üóëÔ∏è</button></td></tr>`; }); } catch (e) { console.error(e); tb.innerHTML = `<tr><td colspan="4" class="text-danger small">Erro</td></tr>`; } };
  window.excluirTransacao = (idTransacao, idCliente, valor, tipo, metodo) => { pedirSenha(async () => { const refCli = doc(db, "clientes", idCliente); const snap = await getDoc(refCli); let saldoAtual = snap.data().saldo || 0; if (tipo === 'VENDA' && metodo === 'FIADO') { saldoAtual += valor; } else if (tipo === 'PAGAMENTO') { saldoAtual -= valor; } await updateDoc(refCli, { saldo: saldoAtual }); await deleteDoc(doc(db, "transacoes", idTransacao)); bootstrap.Modal.getInstance(document.getElementById('modalExtrato')).hide(); carregarClientes(); alert("Item exclu√≠do!"); }); };
  function formatarData(iso) { if(!iso) return ""; return iso.split('-').reverse().join('/'); }
  window.abrirPagamento = (id) => { document.getElementById('idClientePgto').value=id; document.getElementById('valorPgto').value=''; document.getElementById('dataPgto').valueAsDate=new Date(); new bootstrap.Modal(document.getElementById('modalPagamento')).show(); };
  window.confirmarPagamento = async () => { const id=document.getElementById('idClientePgto').value; const v=parseFloat(document.getElementById('valorPgto').value); const d=document.getElementById('dataPgto').value; if(!v) return alert("Valor?"); const ref=doc(db,"clientes",id); const s=await getDoc(ref); await updateDoc(ref,{saldo:(s.data().saldo||0)+v}); await addDoc(collection(db,"transacoes"),{cliente_id:id, tipo:'PAGAMENTO', metodo:'DINHEIRO', valor:v, descricao:'Pagamento', data:d, timestamp:new Date()}); bootstrap.Modal.getInstance(document.getElementById('modalPagamento')).hide(); carregarClientes(); alert("Recebido!"); };
  window.pedirSenha = (cb) => { SENHA_CALLBACK=cb; document.getElementById('inputSenha').value=''; new bootstrap.Modal(document.getElementById('modalSenha')).show(); };
  window.validarSenha = () => { if(document.getElementById('inputSenha').value==='0309') { bootstrap.Modal.getInstance(document.getElementById('modalSenha')).hide(); if(SENHA_CALLBACK) SENHA_CALLBACK(); } else alert("Senha!"); };
  window.desbloquearComSenha = () => { pedirSenha(()=>{ document.getElementById('boxBloqueio').classList.add('d-none'); document.getElementById('areaVendaInputs').classList.remove('d-none'); }); };
  window.processarExcel = () => { const f=document.getElementById('arquivoExcel'); if(!f.files[0]) return alert("Arquivo?"); const r=new FileReader(); r.onload=async(e)=>{ const d=new Uint8Array(e.target.result); const w=XLSX.read(d,{type:'array'}); const s=w.Sheets[w.SheetNames[0]]; const dd=XLSX.utils.sheet_to_json(s); let n=0; for(let lin of dd) { const nm=lin['NOME']; if(!nm) continue; const chk=await getDocs(query(collection(db,"clientes"),where("nome","==",nm.toUpperCase()))); if(chk.empty) { let tot=lin['TOTAL']; if(typeof tot==='string') tot=parseFloat(tot.replace('R$','').replace(',','.')); if(!tot) tot=0; const sal=tot>0?-Math.abs(tot):0; const ref=await addDoc(collection(db,"clientes"),{nome:nm.toUpperCase(), setor:(lin['SETOR']||'GERAL').toUpperCase(), telefone:lin['TELEFONE']||'', saldo:sal, vencimento:null}); if(sal<0) await addDoc(collection(db,"transacoes"),{cliente_id:ref.id, tipo:'VENDA', metodo:'FIADO', valor:Math.abs(sal), descricao:'Importado', data:new Date().toISOString().split('T')[0], timestamp:new Date()}); n++; } } alert(`Importados: ${n}`); carregarClientes(); }; r.readAsArrayBuffer(f.files[0]); };

</script>
</body>
</html>
