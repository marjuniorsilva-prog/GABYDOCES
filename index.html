<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gaby Doces - V9.0 (Controle de Vencimento)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <style>
        body { background-color: #f2f4f8; padding-bottom: 100px; font-family: sans-serif; }
        .nav-pills .nav-link.active { background-color: #d63384; color: white; font-weight: bold; }
        .nav-pills .nav-link { background: white; color: #666; margin: 0 2px; border: 1px solid #ddd; }
        
        /* Cores do Dashboard */
        .card-dash { cursor: pointer; color: white; border: none; transition: 0.2s; }
        .card-dash:active { transform: scale(0.98); }
        .bg-vence-hoje { background: linear-gradient(135deg, #fce38a, #f38181); color: #333; }
        .bg-atrasado { background: linear-gradient(135deg, #ff416c, #ff4b2b); }
        .bg-ok { background: linear-gradient(135deg, #00b09b, #96c93d); }
        
        /* Status dos Clientes */
        .card-cliente { border-left: 5px solid #ccc; }
        .status-devendo { border-left-color: #dc3545; background-color: #fff8f8; }
        .status-ok { border-left-color: #198754; background-color: #fff; }
        
        .badge-vencido { background-color: #dc3545; color: white; animation: pulse 2s infinite; }
        .badge-hoje { background-color: #ffc107; color: black; font-weight: bold; border: 1px solid #daa520; }
        .badge-prazo { background-color: #0dcaf0; color: black; }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>

<div class="container mt-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="fw-bold text-secondary m-0">üç¨ Gaby Doces <span class="badge bg-dark small">V9.0</span></h5>
        <button class="btn btn-sm btn-light border" onclick="location.reload()">üîÑ</button>
    </div>

    <ul class="nav nav-pills nav-fill mb-4" id="menuPrincipal" role="tablist">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-inicio">üè† Clientes</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-dash" onclick="carregarDashboard()">üìÖ Cobran√ßa</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-novo">üë§ Novo</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-prod">üì¶ Prod</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-config">‚öôÔ∏è Config</button></li>
    </ul>
</div>

<div class="tab-content container">

    <div class="tab-pane fade show active" id="tab-inicio">
        <div class="input-group mb-3">
            <input type="text" id="buscaNome" class="form-control" placeholder="üîç Buscar..." onkeyup="carregarClientes()">
            <select id="filtroSetor" class="form-select" style="max-width: 130px;" onchange="carregarClientes()">
                <option value="">Setor</option>
                <option value="IGREJA">Igreja</option>
                <option value="ROLETE">Rolete</option>
                <option value="TABATA">Tabata</option>
                <option value="ANDERSON">Anderson</option>
                <option value="BIANCA">Bianca</option>
                <option value="RUA">Rua</option>
            </select>
        </div>
        <div id="listaClientes" class="row pb-5">
            <div class="text-center mt-5"><div class="spinner-border text-primary"></div></div>
        </div>
    </div>

    <div class="tab-pane fade" id="tab-dash">
        <h6 class="text-muted fw-bold mb-3">Resumo de Cobran√ßa (Hoje: <span id="dataHojeDisplay"></span>)</h6>
        
        <div class="row g-2">
            <div class="col-12">
                <div class="card card-dash bg-vence-hoje p-3 shadow" onclick="filtrarRelatorio('HOJE')">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="fw-bold mb-0">üü° VENCE HOJE</h5>
                            <small>Clientes combinaram pagar hoje</small>
                        </div>
                        <h3 class="fw-bold m-0" id="cntHoje">0</h3>
                    </div>
                </div>
            </div>
            
            <div class="col-6">
                <div class="card card-dash bg-atrasado p-3 shadow" onclick="filtrarRelatorio('ATRASADO')">
                    <small>üî¥ Vencidos</small>
                    <h4 class="fw-bold mb-0" id="cntAtrasados">0</h4>
                    <span class="badge bg-white text-danger small">Ver Lista</span>
                </div>
            </div>
            
            <div class="col-6">
                <div class="card card-dash bg-ok p-3 shadow" onclick="filtrarRelatorio('PRAZO')">
                    <small>üîµ No Prazo</small>
                    <h4 class="fw-bold mb-0" id="cntPrazo">0</h4>
                    <span class="badge bg-white text-success small">Ver Lista</span>
                </div>
            </div>
        </div>

        <div id="areaRelatorio" class="mt-4">
            <p class="text-center text-muted small">Clique nos cart√µes acima para ver quem cobrar.</p>
        </div>
    </div>

    <div class="tab-pane fade" id="tab-novo">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5>Cadastrar Cliente</h5>
                <input type="text" id="novoNome" class="form-control mb-2" placeholder="Nome Completo">
                <select id="novoSetor" class="form-select mb-2">
                    <option value="IGREJA">Igreja</option>
                    <option value="ROLETE">Rolete</option>
                    <option value="TABATA">Tabata</option>
                    <option value="ANDERSON">Anderson</option>
                    <option value="BIANCA">Bianca</option>
                    <option value="RUA">Rua/Outros</option>
                </select>
                <input type="text" id="novoTel" class="form-control mb-2" placeholder="Telefone">
                
                <label class="fw-bold small text-muted">Data de Vencimento (Combinado):</label>
                <input type="date" id="novoVencimento" class="form-control mb-3">
                
                <button class="btn btn-primary w-100" onclick="salvarNovoCliente()">Salvar</button>
            </div>
        </div>
    </div>

    <div class="tab-pane fade" id="tab-prod">
        <div class="input-group mb-3">
            <input type="text" id="prodNome" class="form-control" placeholder="Produto">
            <input type="number" id="prodPreco" class="form-control" placeholder="R$">
            <button class="btn btn-success" onclick="addProduto()">Add</button>
        </div>
        <ul id="listaProdutos" class="list-group shadow-sm"></ul>
    </div>

    <div class="tab-pane fade" id="tab-config">
        <div class="card border-warning shadow-sm">
            <div class="card-header bg-warning fw-bold">üì• Importar Excel</div>
            <div class="card-body">
                <input type="file" id="arquivoExcel" class="form-control mb-3" accept=".xlsx, .xls">
                <button class="btn btn-dark w-100" onclick="processarExcel()">Ler Planilha</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalVenda" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title fw-bold" id="tituloVenda">Venda</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="idClienteVenda">
                
                <div id="boxBloqueio" class="alert alert-danger d-none text-center p-2">
                    <strong>‚õî DEVEDOR ATRASADO!</strong><br>
                    <button class="btn btn-sm btn-outline-danger mt-2" onclick="desbloquearComSenha()">Liberar c/ Senha 0309</button>
                </div>

                <div id="areaVendaInputs">
                    <div class="input-group mb-2">
                        <select id="selectProdVenda" class="form-select"></select>
                        <input type="number" id="qtdProdVenda" class="form-control" value="1" style="max-width: 60px;">
                        <button class="btn btn-primary" onclick="addCarrinho()">‚ûï</button>
                    </div>
                    <ul class="list-group mb-2 bg-light" id="listaCarrinho" style="max-height: 120px; overflow-y: auto;">
                        <li class="list-group-item text-center small text-muted">Carrinho vazio</li>
                    </ul>
                    <h4 class="text-end fw-bold text-primary" id="totalCarrinho">R$ 0,00</h4>
                    
                    <div class="d-flex gap-2 mb-3 mt-3">
                        <input type="radio" class="btn-check" name="tipoVenda" id="optFiado" value="FIADO" checked>
                        <label class="btn btn-outline-danger w-50" for="optFiado">üî¥ FIADO</label>
                        <input type="radio" class="btn-check" name="tipoVenda" id="optVista" value="VISTA">
                        <label class="btn btn-outline-success w-50" for="optVista">üü¢ √Ä VISTA</label>
                    </div>
                    
                    <input type="date" id="dataVenda" class="form-control mb-2">
                    <button class="btn btn-dark w-100 py-2" onclick="finalizarVenda()">‚úÖ CONCLUIR</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalPagamento" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">üí∞ Receber</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <input type="hidden" id="idClientePgto">
                <p class="mb-1">Valor recebido:</p>
                <input type="number" id="valorPgto" class="form-control fs-1 text-center text-success fw-bold mb-3" placeholder="0,00">
                <input type="date" id="dataPgto" class="form-control">
                <button class="btn btn-success w-100 mt-3 fw-bold" onclick="confirmarPagamento()">CONFIRMAR</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalVencimento" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title">Alterar Data Combinada</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="idClienteVenc">
                <label>Nova Data:</label>
                <input type="date" id="novaDataVenc" class="form-control mb-3">
                <button class="btn btn-primary w-100" onclick="salvarVencimento()">Salvar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalExtrato" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title">üìú Hist√≥rico</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <table class="table table-striped mb-0 small">
                    <thead class="table-dark"><tr><th>Data</th><th>Movimenta√ß√£o</th><th>R$</th></tr></thead>
                    <tbody id="tabelaExtrato"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalSenha" tabindex="-1" style="z-index: 1070;">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content border-danger">
            <div class="modal-body text-center">
                <strong class="text-danger">üîí SENHA:</strong>
                <input type="password" id="inputSenha" class="form-control text-center fs-4 my-2" placeholder="****">
                <button class="btn btn-danger w-100" onclick="validarSenha()">OK</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, query, where, updateDoc, doc, orderBy, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBUFv4jrng5g-0eUT9zjDukZGA46eVH7g0",
    authDomain: "gabydoces-d0cd1.firebaseapp.com",
    projectId: "gabydoces-d0cd1",
    storageBucket: "gabydoces-d0cd1.firebasestorage.app",
    messagingSenderId: "702910388683",
    appId: "1:702910388683:web:28facd97365fb586373e4e"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let CARRINHO = [];
  let TOTAL_CARRINHO = 0;
  let SENHA_CALLBACK = null;

  window.onload = () => {
      carregarClientes();
      carregarProdutos();
      document.getElementById('dataVenda').valueAsDate = new Date();
      document.getElementById('dataHojeDisplay').innerText = new Date().toLocaleDateString('pt-BR');
  };

  // 1. CLIENTES COM VENCIMENTO
  window.carregarClientes = async () => {
      const lista = document.getElementById('listaClientes');
      const busca = document.getElementById('buscaNome').value.toLowerCase();
      const setor = document.getElementById('filtroSetor').value;
      
      lista.innerHTML = '<div class="text-center mt-5"><div class="spinner-border text-primary"></div></div>';

      const q = query(collection(db, "clientes"), orderBy("nome"));
      const snap = await getDocs(q);
      lista.innerHTML = '';
      
      const hoje = new Date().toISOString().split('T')[0];

      snap.forEach(d => {
          const c = d.data();
          if (busca && !c.nome.toLowerCase().includes(busca)) return;
          if (setor && c.setor !== setor) return;

          const saldo = parseFloat(c.saldo) || 0;
          const devedor = saldo < -0.01;
          
          let cardColor = 'status-ok';
          let textColor = 'texto-ok';
          let badgeVencimento = '';

          // L√≥gica do Vencimento
          if (devedor) {
              cardColor = 'status-devendo';
              textColor = 'texto-devendo';
              
              if (c.vencimento) {
                  if (c.vencimento < hoje) {
                      badgeVencimento = `<span class="badge badge-vencido w-100 mb-2">üî¥ ATRASADO (era ${c.vencimento.split('-').reverse().join('/')})</span>`;
                  } else if (c.vencimento === hoje) {
                      badgeVencimento = `<span class="badge badge-hoje w-100 mb-2">üü° VENCE HOJE! COBRAR!</span>`;
                  } else {
                      badgeVencimento = `<span class="badge badge-prazo w-100 mb-2">üîµ Vence: ${c.vencimento.split('-').reverse().join('/')}</span>`;
                  }
              } else {
                  badgeVencimento = `<span class="badge bg-secondary w-100 mb-2">‚ö™ Sem data combinada</span>`;
              }
          }

          const txtSaldo = devedor ? `DEVE R$ ${Math.abs(saldo).toFixed(2)}` : `CR√âDITO R$ ${saldo.toFixed(2)}`;

          lista.innerHTML += `
            <div class="col-md-6 mb-2">
                <div class="card shadow-sm card-cliente ${cardColor}">
                    <div class="card-body p-2">
                        <div class="d-flex justify-content-between">
                            <h6 class="fw-bold text-truncate" style="max-width: 65%">${c.nome}</h6>
                            <span class="badge bg-secondary" style="font-size: 0.7rem">${c.setor}</span>
                        </div>
                        
                        ${badgeVencimento}
                        
                        <div class="${textColor} fs-5 mb-1 d-flex justify-content-between align-items-center">
                            ${txtSaldo}
                            <button class="btn btn-sm btn-link text-decoration-none" onclick="abrirEditarVenc('${d.id}', '${c.vencimento || ''}')">üìÖ Mudar Data</button>
                        </div>
                        
                        <div class="d-flex gap-1 mt-2">
                            <button class="btn btn-outline-danger btn-sm w-100" onclick="abrirVenda('${d.id}', '${c.nome}', ${saldo})">Vender</button>
                            <button class="btn btn-outline-success btn-sm w-100" onclick="abrirPagamento('${d.id}')">Receber</button>
                        </div>
                        <div class="text-end mt-1">
                            <button class="btn btn-link btn-sm text-decoration-none text-muted" onclick="verExtrato('${d.id}')">üìÑ Ver Hist√≥rico</button>
                        </div>
                    </div>
                </div>
            </div>`;
      });
  };

  // 2. FUN√á√ïES VENCIMENTO
  window.abrirEditarVenc = (id, dataAtual) => {
      document.getElementById('idClienteVenc').value = id;
      document.getElementById('novaDataVenc').value = dataAtual;
      new bootstrap.Modal(document.getElementById('modalVencimento')).show();
  };

  window.salvarVencimento = async () => {
      const id = document.getElementById('idClienteVenc').value;
      const data = document.getElementById('novaDataVenc').value;
      
      const ref = doc(db, "clientes", id);
      await updateDoc(ref, { vencimento: data });
      
      bootstrap.Modal.getInstance(document.getElementById('modalVencimento')).hide();
      carregarClientes();
      alert("Data de vencimento atualizada!");
  };

  window.salvarNovoCliente = async () => {
      const nome = document.getElementById('novoNome').value.toUpperCase();
      const setor = document.getElementById('novoSetor').value;
      const tel = document.getElementById('novoTel').value;
      const venc = document.getElementById('novoVencimento').value;

      if(!nome) return alert("Nome √© obrigat√≥rio!");
      const check = await getDocs(query(collection(db, "clientes"), where("nome", "==", nome)));
      if(!check.empty) return alert("J√° existe!");

      await addDoc(collection(db, "clientes"), { 
          nome, setor, telefone: tel, saldo: 0, 
          vencimento: venc // Salva a data combinada
      });
      alert("Salvo!");
      document.querySelector('[data-bs-target="#tab-inicio"]').click();
      carregarClientes();
  };

  // 3. DASHBOARD INTELIGENTE
  window.carregarDashboard = async () => {
      const hoje = new Date().toISOString().split('T')[0];
      const q = query(collection(db, "clientes"));
      const snap = await getDocs(q);
      
      let hojeCount = 0;
      let atrasadoCount = 0;
      let prazoCount = 0;
      
      snap.forEach(d => {
          const c = d.data();
          if (c.saldo < -0.01) { // S√≥ quem deve
              if (c.vencimento) {
                  if (c.vencimento === hoje) hojeCount++;
                  else if (c.vencimento < hoje) atrasadoCount++;
                  else prazoCount++;
              }
          }
      });
      
      document.getElementById('cntHoje').innerText = hojeCount;
      document.getElementById('cntAtrasados').innerText = atrasadoCount;
      document.getElementById('cntPrazo').innerText = prazoCount;
  };

  window.filtrarRelatorio = async (tipo) => {
      const area = document.getElementById('areaRelatorio');
      area.innerHTML = '<div class="spinner-border text-primary"></div>';
      const hoje = new Date().toISOString().split('T')[0];
      
      const q = query(collection(db, "clientes"), orderBy("nome"));
      const snap = await getDocs(q);
      
      let html = '<ul class="list-group">';
      
      snap.forEach(d => {
          const c = d.data();
          if (c.saldo < -0.01 && c.vencimento) {
              let mostrar = false;
              let cor = "";
              
              if (tipo === 'HOJE' && c.vencimento === hoje) { mostrar = true; cor = "text-warning"; }
              if (tipo === 'ATRASADO' && c.vencimento < hoje) { mostrar = true; cor = "text-danger"; }
              if (tipo === 'PRAZO' && c.vencimento > hoje) { mostrar = true; cor = "text-success"; }
              
              if (mostrar) {
                  html += `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${c.nome}</strong> (${c.setor})<br>
                            <small class="text-muted">Vence: ${c.vencimento.split('-').reverse().join('/')}</small>
                        </div>
                        <span class="${cor} fw-bold">R$ ${Math.abs(c.saldo).toFixed(2)}</span>
                    </li>`;
              }
          }
      });
      html += '</ul>';
      area.innerHTML = html;
  };

  // --- OUTRAS FUN√á√ïES (IGUAIS V8) ---
  window.abrirVenda = (id, nome, saldo) => {
      CARRINHO = []; TOTAL_CARRINHO = 0; atualizarCarrinho();
      document.getElementById('idClienteVenda').value = id;
      document.getElementById('tituloVenda').innerText = `Venda: ${nome}`;
      const bloqueado = saldo < -1;
      document.getElementById('boxBloqueio').classList.toggle('d-none', !bloqueado);
      document.getElementById('areaVendaInputs').classList.toggle('d-none', bloqueado);
      new bootstrap.Modal(document.getElementById('modalVenda')).show();
  };

  window.desbloquearComSenha = () => { pedirSenha(() => { document.getElementById('boxBloqueio').classList.add('d-none'); document.getElementById('areaVendaInputs').classList.remove('d-none'); }); };
  window.addCarrinho = () => {
      const select = document.getElementById('selectProdVenda');
      const qtd = parseFloat(document.getElementById('qtdProdVenda').value);
      const preco = parseFloat(select.value);
      const nome = select.options[select.selectedIndex].getAttribute('data-nome');
      if(!nome) return;
      CARRINHO.push({ nome, qtd, total: preco * qtd });
      TOTAL_CARRINHO += preco * qtd;
      atualizarCarrinho();
  };
  function atualizarCarrinho() {
      const lista = document.getElementById('listaCarrinho'); lista.innerHTML = '';
      CARRINHO.forEach((i) => { lista.innerHTML += `<li class="list-group-item d-flex justify-content-between p-1 small">${i.qtd}x ${i.nome} <span>R$ ${i.total.toFixed(2)}</span></li>`; });
      document.getElementById('totalCarrinho').innerText = `R$ ${TOTAL_CARRINHO.toFixed(2)}`;
  }
  window.finalizarVenda = async () => {
      if(CARRINHO.length === 0) return alert("Carrinho vazio!");
      const id = document.getElementById('idClienteVenda').value;
      const tipo = document.querySelector('input[name="tipoVenda"]:checked').value;
      const data = document.getElementById('dataVenda').value;
      const ref = doc(db, "clientes", id);
      const snap = await getDoc(ref);
      let saldoAtual = snap.data().saldo || 0;
      if (tipo === 'FIADO') { saldoAtual -= TOTAL_CARRINHO; await updateDoc(ref, { saldo: saldoAtual, ultima_venda: data }); } 
      else { await updateDoc(ref, { ultima_venda: data }); }
      const desc = CARRINHO.map(i => `${i.qtd}x ${i.nome}`).join(', ');
      await addDoc(collection(db, "transacoes"), { cliente_id: id, tipo: 'VENDA', metodo: tipo, valor: TOTAL_CARRINHO, descricao: desc, data: data, timestamp: new Date() });
      bootstrap.Modal.getInstance(document.getElementById('modalVenda')).hide(); carregarClientes(); alert("Sucesso!");
  };

  window.abrirPagamento = (id) => { document.getElementById('idClientePgto').value = id; document.getElementById('valorPgto').value = ''; document.getElementById('dataPgto').valueAsDate = new Date(); new bootstrap.Modal(document.getElementById('modalPagamento')).show(); };
  window.confirmarPagamento = async () => {
      const id = document.getElementById('idClientePgto').value; const valor = parseFloat(document.getElementById('valorPgto').value); const data = document.getElementById('dataPgto').value;
      if(!valor) return alert("Valor inv√°lido");
      const ref = doc(db, "clientes", id); const snap = await getDoc(ref); await updateDoc(ref, { saldo: (snap.data().saldo || 0) + valor });
      await addDoc(collection(db, "transacoes"), { cliente_id: id, tipo: 'PAGAMENTO', metodo: 'DINHEIRO', valor: valor, descricao: 'Pagamento Recebido', data: data, timestamp: new Date() });
      bootstrap.Modal.getInstance(document.getElementById('modalPagamento')).hide(); carregarClientes(); alert("Recebido!");
  };

  window.verExtrato = async (id) => {
      const modal = new bootstrap.Modal(document.getElementById('modalExtrato')); modal.show();
      const tb = document.getElementById('tabelaExtrato'); tb.innerHTML = ''; 
      const q = query(collection(db, "transacoes"), where("cliente_id", "==", id), orderBy("timestamp", "desc"));
      const snap = await getDocs(q);
      snap.forEach(d => {
          const t = d.data();
          const isPgto = t.tipo === 'PAGAMENTO'; const cor = isPgto ? 'text-success' : 'text-danger'; const sinal = isPgto ? '+' : '-'; const obs = t.metodo === 'VISTA' ? ' <span class="badge bg-success">√Ä Vista</span>' : '';
          tb.innerHTML += `<tr><td>${t.data.split('-').reverse().join('/')}</td><td><strong class="small">${t.tipo}${obs}</strong><br><small class="text-muted">${t.descricao}</small></td><td class="${cor} fw-bold text-end">${sinal} R$ ${t.valor.toFixed(2)}</td></tr>`;
      });
  };

  window.carregarProdutos = async () => { const sel = document.getElementById('selectProdVenda'); const lst = document.getElementById('listaProdutos'); const q = query(collection(db, "produtos")); const snap = await getDocs(q); sel.innerHTML = ''; lst.innerHTML = ''; snap.forEach(d => { const p = d.data(); sel.innerHTML+=`<option value="${p.preco}" data-nome="${p.nome}">${p.nome} (R$${p.preco})</option>`; lst.innerHTML+=`<li class="list-group-item d-flex justify-content-between">${p.nome} <span>R$${p.preco}</span></li>`; }); };
  window.addProduto = async () => { const nome = document.getElementById('prodNome').value.toUpperCase(); const preco = parseFloat(document.getElementById('prodPreco').value); if(nome && preco) { await addDoc(collection(db, "produtos"), {nome, preco}); carregarProdutos(); document.getElementById('prodNome').value=''; document.getElementById('prodPreco').value=''; } };
  window.pedirSenha = (cb) => { SENHA_CALLBACK = cb; document.getElementById('inputSenha').value=''; new bootstrap.Modal(document.getElementById('modalSenha')).show(); };
  window.validarSenha = () => { if(document.getElementById('inputSenha').value==='0309') { bootstrap.Modal.getInstance(document.getElementById('modalSenha')).hide(); if(SENHA_CALLBACK) SENHA_CALLBACK(); } else alert("Senha errada!"); };
  window.processarExcel = () => {
    const fileInput = document.getElementById('arquivoExcel'); if(!fileInput.files[0]) return alert("Selecione arquivo!");
    const reader = new FileReader(); reader.onload = async (e) => {
        const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, {type:'array'});
        const sheet = workbook.Sheets[workbook.SheetNames[0]]; const dados = XLSX.utils.sheet_to_json(sheet);
        let n=0;
        for(let r of dados) { const nome=r['NOME']; if(!nome) continue;
            const check = await getDocs(query(collection(db,"clientes"), where("nome","==",nome.toUpperCase())));
            if(check.empty) {
                let total = r['TOTAL']; if(typeof total==='string') total=parseFloat(total.replace('R$','').replace(',','.')); if(!total) total=0;
                const saldo = total>0 ? -Math.abs(total) : 0;
                const ref = await addDoc(collection(db,"clientes"), { nome:nome.toUpperCase(), setor:(r['SETOR']||'GERAL').toUpperCase(), telefone:r['TELEFONE']||'', saldo, vencimento: null });
                if(saldo<0) await addDoc(collection(db,"transacoes"),{ cliente_id:ref.id, tipo:'VENDA', metodo:'FIADO', valor:Math.abs(saldo), descricao:'Importado', data:new Date().toISOString().split('T')[0], timestamp:new Date() });
                n++;
            }
        }
        alert(`Importados: ${n}`); carregarClientes();
    }; reader.readAsArrayBuffer(fileInput.files[0]);
  };
</script>
</body>
</html>
