<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gaby Doces V27</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { 50: '#fdf2f8', 100: '#fce7f3', 500: '#ec4899', 600: '#db2777', 900: '#831843' }
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #fdf2f8; }
        .hide { display: none !important; }
        .anime-fade { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="text-slate-800 h-screen flex overflow-hidden">

    <aside class="w-64 bg-white border-r border-pink-100 hidden md:flex flex-col shadow-sm z-20">
        <div class="p-6">
            <h1 class="text-2xl font-bold text-brand-600 flex items-center gap-2">
                <i class="fa-solid fa-candy-cane"></i> Gaby Doces
            </h1>
            <p class="text-xs text-slate-400 mt-1 pl-7">Sistema Inteligente V27</p>
        </div>
        <nav class="flex-1 px-4 space-y-2 mt-4">
            <button onclick="mudarAba('clientes')" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-pink-50 text-slate-500 hover:text-brand-600 transition-all active-nav" id="btn-clientes">
                <i class="fa-solid fa-users w-5"></i> Clientes
            </button>
            <button onclick="mudarAba('cobranca')" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-pink-50 text-slate-500 hover:text-brand-600 transition-all" id="btn-cobranca">
                <i class="fa-solid fa-hand-holding-dollar w-5"></i> Cobrança
            </button>
            <button onclick="mudarAba('novo')" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-pink-50 text-slate-500 hover:text-brand-600 transition-all" id="btn-novo">
                <i class="fa-solid fa-user-plus w-5"></i> Novo Cliente
            </button>
            <button onclick="mudarAba('prod')" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-pink-50 text-slate-500 hover:text-brand-600 transition-all" id="btn-prod">
                <i class="fa-solid fa-box-open w-5"></i> Produtos
            </button>
            <button onclick="mudarAba('config')" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-pink-50 text-slate-500 hover:text-brand-600 transition-all" id="btn-config">
                <i class="fa-solid fa-gear w-5"></i> Config
            </button>
        </nav>
    </aside>

    <main class="flex-1 flex flex-col h-screen overflow-hidden relative">
        
        <header class="bg-white/80 backdrop-blur border-b border-pink-100 p-4 flex justify-between items-center md:hidden z-10">
            <h1 class="font-bold text-brand-600"><i class="fa-solid fa-candy-cane"></i> GabyDoces</h1>
            <button onclick="document.querySelector('aside').classList.toggle('hidden'); document.querySelector('aside').classList.toggle('absolute'); document.querySelector('aside').classList.toggle('h-full');" class="text-slate-500 p-2"><i class="fa-solid fa-bars fa-lg"></i></button>
        </header>

        <div class="flex-1 overflow-y-auto p-4 md:p-8 relative">
            
            <section id="tab-clientes" class="anime-fade space-y-6">
                <div class="flex flex-col md:flex-row gap-4 bg-white p-4 rounded-2xl shadow-sm">
                    <div class="flex-1 relative">
                        <i class="fa-solid fa-magnifying-glass absolute left-4 top-3.5 text-slate-400"></i>
                        <input type="text" id="buscaNome" onkeyup="renderClientes()" placeholder="Buscar cliente..." class="w-full pl-10 pr-4 py-3 bg-slate-50 border-transparent focus:bg-white focus:ring-2 focus:ring-brand-100 rounded-xl outline-none transition-all">
                    </div>
                    <select id="filtroSetor" onchange="renderClientes()" class="px-4 py-3 bg-slate-50 rounded-xl outline-none border-transparent focus:ring-2 focus:ring-brand-100">
                        <option value="">Todos os Setores</option>
                        <option value="IGREJA">Igreja</option><option value="ROLETE">Rolete</option><option value="TABATA">Tabata</option>
                        <option value="ANDERSON">Anderson</option><option value="BIANCA">Bianca</option><option value="RUA">Rua</option>
                    </select>
                </div>

                <div id="gridClientes" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="text-center w-full col-span-3 text-slate-400 py-10">Carregando clientes...</div>
                </div>
            </section>

            <section id="tab-cobranca" class="hide anime-fade space-y-6">
                <h2 class="text-2xl font-bold text-slate-700">Painel de Cobrança</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <button onclick="renderCobranca('hoje')" class="p-4 bg-blue-50 text-blue-700 rounded-2xl text-left hover:bg-blue-100 transition">
                        <div class="text-sm font-bold uppercase opacity-70">Vence Hoje</div>
                        <div class="text-2xl font-black mt-1" id="total-hoje">R$ 0,00</div>
                    </button>
                    <button onclick="renderCobranca('avencer')" class="p-4 bg-green-50 text-green-700 rounded-2xl text-left hover:bg-green-100 transition">
                        <div class="text-sm font-bold uppercase opacity-70">A Vencer</div>
                        <div class="text-2xl font-black mt-1" id="total-avencer">R$ 0,00</div>
                    </button>
                    <button onclick="renderCobranca('atrasados')" class="p-4 bg-red-50 text-red-700 rounded-2xl text-left hover:bg-red-100 transition">
                        <div class="text-sm font-bold uppercase opacity-70">Atrasados</div>
                        <div class="text-2xl font-black mt-1" id="total-atrasados">R$ 0,00</div>
                    </button>
                </div>
                <div id="listaCobranca" class="bg-white rounded-2xl shadow-sm border border-slate-100 divide-y">
                    </div>
            </section>

            <section id="tab-novo" class="hide anime-fade">
                <div class="max-w-lg mx-auto bg-white p-8 rounded-2xl shadow-sm border border-brand-100">
                    <h2 class="text-xl font-bold mb-6 text-brand-600 flex items-center gap-2"><i class="fa-solid fa-user-plus"></i> Novo Cadastro</h2>
                    <div class="space-y-4">
                        <input type="text" id="novoNome" class="w-full p-3 border rounded-xl outline-none focus:ring-2 focus:ring-brand-500" placeholder="Nome Completo">
                        <select id="novoSetor" class="w-full p-3 border rounded-xl outline-none bg-white">
                            <option value="IGREJA">Setor Igreja</option><option value="ROLETE">Setor Rolete</option>
                            <option value="TABATA">Setor Tabata</option><option value="RUA">Rua/Outros</option>
                        </select>
                        <input type="text" id="novoTel" class="w-full p-3 border rounded-xl outline-none" placeholder="Telefone (WhatsApp)">
                        <select id="novoDia" class="w-full p-3 border rounded-xl outline-none bg-white">
                            <option value="">Escolha o Dia de Pagamento...</option>
                            </select>
                        <button onclick="salvarNovoCliente()" class="w-full bg-brand-500 hover:bg-brand-600 text-white font-bold py-4 rounded-xl shadow-lg shadow-brand-200 transition-all transform active:scale-95">
                            CADASTRAR
                        </button>
                    </div>
                </div>
            </section>

             <section id="tab-prod" class="hide anime-fade">
                <div class="max-w-2xl mx-auto space-y-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-brand-100 flex gap-3">
                        <input type="text" id="prodNome" class="flex-1 p-3 border rounded-xl outline-none" placeholder="Nome do Doce">
                        <input type="number" id="prodPreco" class="w-24 p-3 border rounded-xl outline-none" placeholder="R$">
                        <button onclick="addProduto()" class="bg-green-500 text-white px-6 rounded-xl hover:bg-green-600 font-bold">+</button>
                    </div>
                    <ul id="listaProdutos" class="space-y-2"></ul>
                </div>
            </section>

            <section id="tab-config" class="hide anime-fade">
                <div class="max-w-2xl mx-auto space-y-6">
                    <div class="bg-white p-8 rounded-2xl shadow-sm border-l-4 border-green-500 text-center">
                        <i class="fa-solid fa-file-excel text-4xl text-green-600 mb-3"></i>
                        <h3 class="text-lg font-bold">Importar Planilha de Pedidos</h3>
                        <p class="text-sm text-slate-400 mb-4">Layout Foto (Colunas A, B + Pares)</p>
                        <input type="file" id="arquivoExcel" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100 cursor-pointer" accept=".xlsx, .xls">
                        <button onclick="importarExcel()" class="mt-4 w-full bg-slate-800 text-white py-2 rounded-lg">PROCESSAR ARQUIVO</button>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm">
                        <h3 class="font-bold mb-4">Configuração WhatsApp</h3>
                        <div class="space-y-3">
                            <input id="cfgPix" class="w-full p-2 border rounded" placeholder="Chave PIX">
                            <textarea id="msgHoje" class="w-full p-2 border rounded" rows="2" placeholder="Msg Vence Hoje"></textarea>
                            <textarea id="msgAtrasado" class="w-full p-2 border rounded" rows="2" placeholder="Msg Atrasado"></textarea>
                            <button onclick="salvarConfig()" class="w-full bg-brand-500 text-white py-2 rounded font-bold">Salvar Textos</button>
                        </div>
                    </div>
                </div>
            </section>

        </div>
    </main>

    <div id="modalVenda" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden anime-fade">
            <div class="bg-brand-50 p-4 border-b border-brand-100 flex justify-between items-center">
                <h3 class="font-bold text-brand-900">Venda para <span id="mv-nome"></span></h3>
                <button onclick="fecharModal('modalVenda')" class="text-brand-900 hover:bg-brand-100 w-8 h-8 rounded-full">✕</button>
            </div>
            <div class="p-6">
                <div class="flex gap-2 mb-4">
                    <select id="mv-prod" class="flex-1 border p-2 rounded-lg"></select>
                    <input id="mv-qtd" type="number" value="1" class="w-16 border p-2 rounded-lg text-center">
                    <button onclick="addCarrinho()" class="bg-brand-500 text-white w-10 rounded-lg">+</button>
                </div>
                <div id="mv-lista" class="bg-slate-50 p-2 rounded-lg h-32 overflow-y-auto mb-4 text-sm space-y-1"></div>
                <div class="flex justify-between font-bold text-xl text-slate-800 mb-6">
                    <span>Total</span> <span id="mv-total">R$ 0,00</span>
                </div>
                <button onclick="finalizarVenda()" class="w-full bg-brand-600 hover:bg-brand-700 text-white py-3 rounded-xl font-bold shadow-lg">CONFIRMAR (FIADO)</button>
            </div>
        </div>
    </div>

    <div id="modalPgto" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl p-6 text-center anime-fade">
            <h3 class="font-bold text-lg mb-2">Receber Pagamento</h3>
            <p class="text-sm text-slate-500 mb-6">Quanto <span id="mp-nome"></span> pagou?</p>
            <input type="number" id="mp-valor" class="text-4xl font-bold text-center w-full border-b-2 border-green-500 focus:outline-none mb-8 text-green-600" placeholder="0,00">
            <div class="flex gap-3">
                <button onclick="fecharModal('modalPgto')" class="flex-1 bg-slate-100 py-3 rounded-xl font-bold text-slate-500">Cancelar</button>
                <button onclick="confirmarPgto()" class="flex-1 bg-green-500 hover:bg-green-600 py-3 rounded-xl font-bold text-white shadow-lg">CONFIRMAR</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIG DO FIREBASE (Sua config original)
        const firebaseConfig = {
            apiKey: "AIzaSyBUFv4jrng5g-0eUT9zjDukZGA46eVH7g0",
            authDomain: "gabydoces-d0cd1.firebaseapp.com",
            projectId: "gabydoces-d0cd1",
            storageBucket: "gabydoces-d0cd1.firebasestorage.app",
            messagingSenderId: "702910388683",
            appId: "1:702910388683:web:28facd97365fb586373e4e"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // VARIÁVEIS GLOBAIS
        let CLIENTES = [];
        let PRODUTOS = [];
        let CARRINHO = [];
        let CLIENTE_ATUAL = null;
        let CONFIG = { pix: "16988143766", hoje: "Oi {nome}, vence hoje: {valor}", atrasado: "Oi {nome}, consta pendencia: {valor}", avencer: "Oi {nome}, vence dia {vencimento}" };

        // INICIALIZAÇÃO
        window.onload = async () => {
            // Preenche dias do select
            const selDia = document.getElementById('novoDia');
            for(let i=1; i<=31; i++) selDia.innerHTML += `<option value="${i}">Dia ${i}</option>`;
            
            await carregarDados();
        };

        async function carregarDados() {
            // Carregar Clientes
            const snapC = await getDocs(collection(db, "clientes"));
            CLIENTES = [];
            snapC.forEach(d => CLIENTES.push({id: d.id, ...d.data()}));
            CLIENTES.sort((a,b) => a.nome.localeCompare(b.nome));

            // Carregar Produtos
            const snapP = await getDocs(collection(db, "produtos"));
            PRODUTOS = [];
            snapP.forEach(d => PRODUTOS.push({id: d.id, ...d.data()}));

            // Carregar Config
            try {
                const snapConf = await getDoc(doc(db, "config", "templates"));
                if(snapConf.exists()) CONFIG = snapConf.data();
                document.getElementById('cfgPix').value = CONFIG.pix || "";
                document.getElementById('msgHoje').value = CONFIG.hoje || "";
                document.getElementById('msgAtrasado').value = CONFIG.atrasado || "";
            } catch(e) {}

            renderClientes();
            renderProdutos();
        }

        // RENDERIZAÇÃO
        window.renderClientes = () => {
            const grid = document.getElementById('gridClientes');
            const busca = document.getElementById('buscaNome').value.toUpperCase();
            const setor = document.getElementById('filtroSetor').value;
            grid.innerHTML = '';

            const filtrados = CLIENTES.filter(c => {
                if(busca && !c.nome.includes(busca)) return false;
                if(setor && c.setor !== setor) return false;
                return true;
            });

            filtrados.forEach(c => {
                const devendo = c.saldo < -0.01;
                const venc = calcularVencimento(c.dia_pagamento, c.ultima_venda);
                const dataVenc = venc ? venc.toLocaleDateString('pt-BR') : '--';
                
                grid.innerHTML += `
                <div class="bg-white p-5 rounded-2xl shadow-sm border-l-4 ${devendo ? 'border-red-500' : 'border-green-500'} hover:shadow-md transition-all">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-bold text-slate-800 truncate pr-2">${c.nome}</h3>
                        <span class="text-[10px] font-bold bg-slate-100 text-slate-500 px-2 py-1 rounded uppercase tracking-wide">${c.setor}</span>
                    </div>
                    <div class="flex justify-between items-end">
                        <div>
                            <p class="text-xs text-slate-400 font-medium">Venc: ${dataVenc}</p>
                            <p class="text-2xl font-bold ${devendo ? 'text-red-600' : 'text-green-600'}">R$ ${Math.abs(c.saldo).toFixed(2)}</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="abrirPagamento('${c.id}')" class="w-10 h-10 rounded-xl bg-green-50 text-green-600 hover:bg-green-500 hover:text-white transition-all flex items-center justify-center"><i class="fa-solid fa-dollar-sign"></i></button>
                            <button onclick="abrirVenda('${c.id}')" class="w-10 h-10 rounded-xl bg-red-50 text-red-600 hover:bg-red-500 hover:text-white transition-all flex items-center justify-center"><i class="fa-solid fa-cart-plus"></i></button>
                        </div>
                    </div>
                </div>`;
            });
        };

        window.renderCobranca = (tipo) => {
            const lista = document.getElementById('listaCobranca');
            lista.innerHTML = '';
            let total = 0;

            const filtrados = CLIENTES.filter(c => {
                if(c.saldo >= -0.01 || !c.dia_pagamento) return false;
                const status = obterStatusVenc(c.dia_pagamento, c.ultima_venda);
                return status === tipo;
            });

            filtrados.forEach(c => {
                total += Math.abs(c.saldo);
                const venc = calcularVencimento(c.dia_pagamento, c.ultima_venda).toLocaleDateString('pt-BR');
                const zapLink = gerarLinkZap(c, tipo, venc);

                lista.innerHTML += `
                <div class="p-4 flex justify-between items-center hover:bg-slate-50">
                    <div>
                        <div class="font-bold text-slate-700">${c.nome}</div>
                        <div class="text-xs text-slate-400">Venc: ${venc}</div>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="font-bold text-red-600">R$ ${Math.abs(c.saldo).toFixed(2)}</div>
                        <a href="${zapLink}" target="_blank" class="w-10 h-10 rounded-full bg-green-500 text-white flex items-center justify-center hover:bg-green-600 shadow-md shadow-green-200"><i class="fa-brands fa-whatsapp"></i></a>
                    </div>
                </div>`;
            });

            document.getElementById(`total-${tipo}`).innerText = `R$ ${total.toFixed(2)}`;
        };

        window.renderProdutos = () => {
            const ul = document.getElementById('listaProdutos');
            const sel = document.getElementById('mv-prod');
            ul.innerHTML = ''; sel.innerHTML = '';
            
            PRODUTOS.forEach(p => {
                ul.innerHTML += `<li class="flex justify-between p-3 bg-white border border-slate-100 rounded-xl mb-2"><span>${p.nome}</span> <b>R$ ${p.preco.toFixed(2)}</b></li>`;
                sel.innerHTML += `<option value="${p.preco}" data-nome="${p.nome}">${p.nome}</option>`;
            });
        };

        // LÓGICA DE NEGÓCIO
        function calcularVencimento(diaPag, ultimaVenda) {
            if(!diaPag) return null;
            let d = ultimaVenda ? new Date(ultimaVenda + 'T00:00:00') : new Date();
            let dia = parseInt(diaPag);
            let ano = d.getFullYear(), mes = d.getMonth();
            if(d.getDate() > dia) mes++;
            if(mes > 11) { mes = 0; ano++; }
            return new Date(ano, mes, Math.min(dia, new Date(ano, mes+1, 0).getDate()));
        }

        function obterStatusVenc(dia, ultVenda) {
            const v = calcularVencimento(dia, ultVenda); if(!v) return 'nada';
            v.setHours(0,0,0,0);
            const hoje = new Date(); hoje.setHours(0,0,0,0);
            if(v.getTime() === hoje.getTime()) return 'hoje';
            if(v.getTime() < hoje.getTime()) return 'atrasados';
            return 'avencer';
        }

        function gerarLinkZap(c, tipo, dataVenc) {
            let msg = CONFIG[tipo] || "";
            msg = msg.replace(/{nome}/g, c.nome)
                     .replace(/{valor}/g, Math.abs(c.saldo).toFixed(2))
                     .replace(/{vencimento}/g, dataVenc)
                     .replace(/{pix}/g, CONFIG.pix);
            return `https://wa.me/55${c.telefone.replace(/\D/g,'')}?text=${encodeURIComponent(msg)}`;
        }

        // MODAIS E AÇÕES
        window.mudarAba = (aba) => {
            document.querySelectorAll('section').forEach(s => s.classList.add('hide'));
            document.getElementById(`tab-${aba}`).classList.remove('hide');
            // Estilo Botão
            document.querySelectorAll('.nav-btn').forEach(b => {
                b.classList.remove('bg-pink-50', 'text-brand-600', 'font-bold');
                b.classList.add('text-slate-500');
            });
            const btn = document.getElementById(`btn-${aba}`);
            if(btn) btn.classList.add('bg-pink-50', 'text-brand-600', 'font-bold');
            
            if(aba === 'cobranca') { renderCobranca('hoje'); renderCobranca('avencer'); renderCobranca('atrasados'); }
        };

        window.abrirVenda = (id) => {
            CLIENTE_ATUAL = CLIENTES.find(c => c.id === id);
            document.getElementById('mv-nome').innerText = CLIENTE_ATUAL.nome;
            CARRINHO = []; atualizarCarrinho();
            document.getElementById('modalVenda').classList.remove('hidden');
        };

        window.addCarrinho = () => {
            const sel = document.getElementById('mv-prod');
            const nome = sel.options[sel.selectedIndex].getAttribute('data-nome');
            const preco = parseFloat(sel.value);
            const qtd = parseFloat(document.getElementById('mv-qtd').value);
            CARRINHO.push({nome, qtd, total: preco * qtd});
            atualizarCarrinho();
        };

        function atualizarCarrinho() {
            const lista = document.getElementById('mv-lista');
            let total = 0; lista.innerHTML = '';
            CARRINHO.forEach(i => {
                total += i.total;
                lista.innerHTML += `<div class="flex justify-between border-b border-slate-200 pb-1"><span>${i.qtd}x ${i.nome}</span><span>R$ ${i.total.toFixed(2)}</span></div>`;
            });
            document.getElementById('mv-total').innerText = `R$ ${total.toFixed(2)}`;
        }

        window.finalizarVenda = async () => {
            if(CARRINHO.length === 0) return;
            const total = CARRINHO.reduce((acc, i) => acc + i.total, 0);
            const novoSaldo = (CLIENTE_ATUAL.saldo || 0) - total;
            
            await updateDoc(doc(db, "clientes", CLIENTE_ATUAL.id), { saldo: novoSaldo, ultima_venda: new Date().toISOString().split('T')[0] });
            await addDoc(collection(db, "transacoes"), {
                cliente_id: CLIENTE_ATUAL.id, tipo: 'VENDA', metodo: 'FIADO', valor: total,
                descricao: CARRINHO.map(i => `${i.qtd}x ${i.nome}`).join(', '), data: new Date().toISOString().split('T')[0], timestamp: new Date()
            });
            
            fecharModal('modalVenda');
            carregarDados();
            alert("Venda Realizada!");
        };

        window.abrirPagamento = (id) => {
            CLIENTE_ATUAL = CLIENTES.find(c => c.id === id);
            document.getElementById('mp-nome').innerText = CLIENTE_ATUAL.nome;
            document.getElementById('mp-valor').value = '';
            document.getElementById('modalPgto').classList.remove('hidden');
        };

        window.confirmarPgto = async () => {
            const valor = parseFloat(document.getElementById('mp-valor').value);
            if(!valor) return;
            const novoSaldo = (CLIENTE_ATUAL.saldo || 0) + valor;
            
            await updateDoc(doc(db, "clientes", CLIENTE_ATUAL.id), { saldo: novoSaldo });
            await addDoc(collection(db, "transacoes"), {
                cliente_id: CLIENTE_ATUAL.id, tipo: 'PAGAMENTO', valor: valor, data: new Date().toISOString().split('T')[0], timestamp: new Date()
            });
            
            fecharModal('modalPgto');
            carregarDados();
        };

        window.fecharModal = (id) => document.getElementById(id).classList.add('hidden');

        window.salvarNovoCliente = async () => {
            const nome = document.getElementById('novoNome').value.toUpperCase();
            if(!nome) return;
            await addDoc(collection(db, "clientes"), {
                nome, setor: document.getElementById('novoSetor').value,
                telefone: document.getElementById('novoTel').value,
                dia_pagamento: document.getElementById('novoDia').value,
                saldo: 0
            });
            document.getElementById('novoNome').value = '';
            carregarDados();
            mudarAba('clientes');
            alert("Cliente cadastrado!");
        };
        
        window.salvarConfig = async () => {
            await setDoc(doc(db, "config", "templates"), {
                pix: document.getElementById('cfgPix').value,
                hoje: document.getElementById('msgHoje').value,
                atrasado: document.getElementById('msgAtrasado').value
            });
            alert("Salvo!");
        };

        window.addProduto = async () => {
            const nome = document.getElementById('prodNome').value.toUpperCase();
            const preco = parseFloat(document.getElementById('prodPreco').value);
            if(nome && preco) {
                await addDoc(collection(db, "produtos"), { nome, preco });
                document.getElementById('prodNome').value = '';
                carregarDados();
            }
        };

        // EXCEL IMPORT (O SEU CÓDIGO)
        window.importarExcel = async () => {
            const file = document.getElementById('arquivoExcel').files[0];
            if(!file) return;
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                const wb = XLSX.read(e.target.result, {type: 'array'});
                const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header: 1});
                
                // Mapeamento Rápido
                const mapCli = {}; CLIENTES.forEach(c => mapCli[c.nome] = c);
                const mapProd = {}; PRODUTOS.forEach(p => mapProd[p.nome] = p.preco);
                
                let count = 0;

                for(let i=1; i<json.length; i++) {
                    const row = json[i];
                    if(!row || !row[1]) continue;
                    
                    const nome = row[1].toString().toUpperCase().trim();
                    const setor = (row[0]||"RUA").toString().toUpperCase();
                    const tel = (row[14]||"").toString().replace(/\D/g, "");
                    
                    let itens = [], totalLinha = 0;
                    for(let k=2; k<=12; k+=2) {
                        const prod = (row[k]||"").toString().toUpperCase().trim();
                        const qtd = parseFloat(row[k+1]);
                        if(prod && qtd > 0) {
                            const preco = mapProd[prod] || 0;
                            totalLinha += preco * qtd;
                            itens.push(`${qtd}x ${prod}`);
                        }
                    }

                    if(itens.length > 0) {
                        let id = null, saldo = 0;
                        if(mapCli[nome]) { id = mapCli[nome].id; saldo = mapCli[nome].saldo; }
                        else {
                            const ref = await addDoc(collection(db, "clientes"), {nome, setor, telefone: tel, dia_pagamento: "", saldo: 0});
                            id = ref.id;
                        }
                        
                        await updateDoc(doc(db, "clientes", id), { saldo: saldo - totalLinha, ultima_venda: new Date().toISOString().split('T')[0] });
                        await addDoc(collection(db, "transacoes"), {
                            cliente_id: id, tipo: 'VENDA', metodo: 'FIADO', valor: totalLinha, descricao: itens.join(', '), data: new Date().toISOString().split('T')[0], timestamp: new Date()
                        });
                        count++;
                    }
                }
                alert(`Importado! ${count} vendas processadas.`);
                carregarDados();
            };
            reader.readAsArrayBuffer(file);
        };
    </script>
</body>
</html>
